"use strict";(()=>{var e={};e.id=242,e.ids=[242,48],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},5462:e=>{e.exports=import("puppeteer")},7683:(e,t,s)=>{s.a(e,async(e,n)=>{try{s.r(t),s.d(t,{originalPathname:()=>m,patchFetch:()=>c,requestAsyncStorage:()=>h,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>d});var r=s(3278),i=s(5002),a=s(4877),o=s(9313),l=e([o]);o=(l.then?(await l)():l)[0];let u=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/assess/route",pathname:"/api/assess",filename:"route",bundlePath:"app/api/assess/route"},resolvedPagePath:"/Users/jeberulz/Downloads/AccessiScan/src/app/api/assess/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:d,serverHooks:p}=u,m="/api/assess/route";function c(){return(0,a.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:d})}n()}catch(e){n(e)}})},9313:(e,t,s)=>{s.a(e,async(e,n)=>{try{s.r(t),s.d(t,{POST:()=>h,runtime:()=>d});var r=s(1769),i=s(4179),a=s(6555),o=s(6053),l=s(1048),c=s(5797),u=e([c]);c=(u.then?(await u)():u)[0];let d="nodejs",p=a.Sg,m=e=>{let t=e.indexOf("--- HUMAN_SUMMARY ---"),s=t>=0?e.slice(0,t):e,n=s.indexOf("{");if(n<0)return null;let r=0,i=!1,a=!1;for(let e=n;e<s.length;e++){let t=s[e];if(i){if(a){a=!1;continue}if("\\"===t){a=!0;continue}'"'===t&&(i=!1);continue}if('"'===t){i=!0;continue}if("{"===t)r++;else if("}"===t&&(r--,0===r))return s.slice(n,e+1)}return null},f=i.Ry({audit_id:i.Z_(),target_summary:i.Ry({type:i.Km(["web","ios","android","hybrid"]).optional(),pages_or_components:i.IX(i.Z_()).optional(),assumptions:i.IX(i.Z_()).optional()}).optional(),overall:i.Ry({grade:i.Z_(),score_0_to_100:i.Rx(),confidence_0_to_1:i.Rx().optional(),pour_scores:i.Ry({perceivable:i.Rx(),operable:i.Rx(),understandable:i.Rx(),robust:i.Rx()})}),top_findings:i.IX(i.Ry({id:i.Z_(),title:i.Z_(),wcag_refs:i.IX(i.Z_()).optional(),pour:i.Z_().optional(),severity_1_to_5:i.Rx(),reach_1_to_5:i.Rx(),frequency_1_to_5:i.Rx(),impact_score:i.Rx(),effort_1_to_5:i.Rx(),priority_score:i.Rx(),confidence_0_to_1:i.Rx().optional(),affected_user_groups:i.IX(i.Z_()).optional(),business_impact:i.Z_().optional(),evidence:i.Ry({selectors:i.IX(i.Z_()).optional(),snippets:i.IX(i.Z_()).optional(),colors:i.IX(i.Ry({fg:i.Z_(),bg:i.Z_(),contrast:i.Rx().optional()})).optional(),locations:i.IX(i.Z_()).optional(),instance_count:i.Rx().optional(),specific_files:i.IX(i.Z_()).optional()}).optional(),recommended_fix:i.IX(i.Z_()).optional(),developer_notes:i.Z_().optional(),test_steps:i.IX(i.Z_()).optional()})),summary_stats:i.Ry({issue_count:i.Rx(),high_priority_count:i.Rx().optional(),est_time_to_relief:i.Z_().optional(),estimated_users_impacted_percent:i.Rx().optional()}),quick_wins:i.IX(i.Ry({id:i.Z_(),why_now:i.Z_().optional(),eta:i.Z_().optional()})).optional(),visualization_spec:i.Yj().optional(),cta:i.Ry({next_steps:i.IX(i.Z_()).optional(),lead_capture_copy:i.Z_().optional(),lead_capture_fields:i.IX(i.Z_()).optional()}).optional(),disclaimers:i.IX(i.Z_()).optional()}),g=i.Ry({id:i.Rx().optional(),category:i.Z_().optional(),title:i.Z_().optional(),description:i.Z_(),userImpact:i.Z_().optional(),impact:i.Km(["critical","high","medium","low"]).optional().default("medium"),wcagRefs:i.IX(i.Z_()).optional(),wcagLevel:i.Z_().optional().default("WCAG 2.2 AA"),instances:i.Rx().optional(),selectors:i.IX(i.Z_()).optional(),evidence:i.Ry({snippets:i.IX(i.Z_()).optional()}).optional(),codeExample:i.Ry({bad:i.Z_().optional(),good:i.Z_().optional()}).optional(),remediationSteps:i.IX(i.Z_()).optional(),timeEstimate:i.Z_().optional(),severity:i.Rx().optional(),reach:i.Rx().optional(),frequency:i.Rx().optional(),impactScore:i.Rx().optional(),effort:i.Rx().optional(),priorityScore:i.Rx().optional(),confidence:i.Rx().optional(),quickFix:i.O7().optional(),previewHighlights:i.IX(i.Ry({x:i.Rx(),y:i.Rx(),w:i.Rx(),h:i.Rx(),note:i.Z_().optional()})).optional()}),y=i.Ry({overall:i.Ry({grade:i.Z_(),score:i.Rx(),pourScores:i.Ry({perceivable:i.Rx(),operable:i.Rx(),understandable:i.Rx(),robust:i.Rx()}),confidence:i.Rx().optional(),potentialScore:i.Rx().optional()}),issueCategories:i.IX(i.Ry({name:i.Z_(),impact:i.Km(["critical","high","medium","low"]).optional(),count:i.Rx().optional(),indices:i.IX(i.Rx()).optional()})).optional(),issues:i.IX(g),recommendations:i.IX(i.Z_()).optional(),quickWins:i.IX(i.Ry({title:i.Z_(),impact:i.Z_().optional(),effort:i.Z_().optional(),eta:i.Z_().optional(),steps:i.IX(i.Z_()).optional()})).optional(),businessImpact:i.Ry({usersAffectedPercent:i.Rx().optional(),legalRiskNote:i.Z_().optional()}).optional()});async function h(e){try{let t,s,n,i,a,u,h;let d=e.headers.get("content-type");if(!d?.includes("application/json"))return new Response(JSON.stringify({success:!1,message:"Content-Type must be application/json"}),{status:400,headers:{"content-type":"application/json"}});try{t=await e.json()}catch{return new Response(JSON.stringify({success:!1,message:"Invalid JSON in request body"}),{status:400,headers:{"content-type":"application/json"}})}try{s=p.parse(t)}catch(e){return new Response(JSON.stringify({success:!1,message:"Invalid request data",errors:e.errors}),{status:400,headers:{"content-type":"application/json"}})}let{websiteUrl:g,imageFile:_,assessmentType:b,email:w,companyName:v}=s;if(!process.env.OPENAI_API_KEY)return new Response(JSON.stringify({success:!1,message:"OpenAI API key not configured"}),{status:500,headers:{"content-type":"application/json"}});let x=new r.ZP({apiKey:process.env.OPENAI_API_KEY}),S="";try{if("image"===b)S="uploaded screenshot",n=await x.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:(0,o.v)("image")},{role:"user",content:[{type:"text",text:"Return MACHINE_OUTPUT JSON followed by a line '--- HUMAN_SUMMARY ---' then the human summary. Analyze this screenshot."},{type:"image_url",image_url:{url:_}}]}],max_tokens:3e3,temperature:.2});else{S=g;try{i=await (0,o.g)(g)}catch(e){console.warn("Screenshot capture failed:",e)}let e=null;try{e=await (0,c.o)(g),console.log(`Extracted ${e.images.length} images, ${e.forms.forms.length} forms, ${e.headings.length} headings`)}catch(e){console.warn("Enhanced crawling failed, falling back to basic analysis:",e)}let t=e?`Return MACHINE_OUTPUT JSON followed by a line '--- HUMAN_SUMMARY ---' then the human summary.

COMPREHENSIVE ACCESSIBILITY ANALYSIS for: ${g}

STRUCTURED DATA PROVIDED:
=========================

PAGE METADATA:
- Title: ${e.pageMetadata.title}
- Language: ${e.pageMetadata.lang||"not specified"}
- Viewport: ${e.pageMetadata.viewport||"not specified"}

IMAGES ANALYSIS (${e.images.length} total):
${e.images.map((e,t)=>`${t+1}. ${e.src} - Alt: ${e.alt||"MISSING"} - Selector: ${e.selector} - Decorative: ${e.isDecorative}`).join("\n")}

FORMS ANALYSIS:
- Total Forms: ${e.forms.forms.length}
- Unlabeled Inputs: ${e.forms.unlabeledInputs.length}
- Missing Fieldsets: ${e.forms.missingFieldsets.length}
- Missing Required Indicators: ${e.forms.missingRequired.length}

HEADINGS STRUCTURE (${e.headings.length} total):
${e.headings.map((e,t)=>`${t+1}. H${e.level}: "${e.text}" - Selector: ${e.selector} - Empty: ${e.isEmpty}`).join("\n")}

LINKS ANALYSIS (${e.links.length} total):
${e.links.map((e,t)=>`${t+1}. "${e.text}" -> ${e.href} - Generic: ${e.hasGenericText} - Empty: ${e.isEmptyLink}`).join("\n")}

COLOR CONTRAST ANALYSIS (${e.colors.length} combinations):
${e.colors.map((e,t)=>`${t+1}. ${e.foreground} on ${e.background} - Contrast: ${e.contrast} - AA: ${e.meetsAA} - Context: ${e.context}`).join("\n")}

INTERACTIVE ELEMENTS (${e.interactiveElements.length} total):
${e.interactiveElements.map((e,t)=>`${t+1}. ${e.tagName} - Touch Target: ${e.touchTargetSize.width}x${e.touchTargetSize.height} - Meets Size: ${e.meetsTouchTargetSize} - Focusable: ${e.isFocusable}`).join("\n")}

LANDMARKS (${e.landmarks.length} total):
${e.landmarks.map((e,t)=>`${t+1}. ${e.landmarkType} - Has Label: ${e.hasLabel} - Selector: ${e.selector}`).join("\n")}

DOCUMENT STRUCTURE:
- Has H1: ${e.documentStructure.hasH1}
- H1 Count: ${e.documentStructure.h1Count}
- Skip Links: ${e.documentStructure.skipLinkCount}
- Landmark Count: ${e.documentStructure.landmarkCount}

FIND MINIMUM 15-20 SPECIFIC ISSUES with exact evidence from this data.`:`Return MACHINE_OUTPUT JSON followed by a line '--- HUMAN_SUMMARY ---' then the human summary. Analyze: ${g}`;n=await x.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:(0,o.v)("url")},{role:"user",content:t}],max_tokens:5e3,temperature:.2})}}catch(t){console.error("OpenAI API error:",t);let e=t?.error?.message||t?.message||"Failed to analyze content";return new Response(JSON.stringify({success:!1,message:`AI analysis failed: ${e}`}),{status:500,headers:{"content-type":"application/json"}})}let A=n.choices[0].message.content||"",I=null,R=m(A);if(R)try{let e=JSON.parse(R);I=f.parse(e);let t="--- HUMAN_SUMMARY ---",s=A.indexOf(t);s>=0&&(a=A.slice(s+t.length).trim())}catch(e){I=null}let $=70,P="B-",E={perceivable:70,operable:70,understandable:70,robust:70},O=[],k=[],C=[];if(I)$=Math.max(0,Math.min(100,Math.round(I.overall.score_0_to_100))),P=I.overall.grade,E=I.overall.pour_scores,k=I.top_findings.map((e,t)=>({type:e.title,description:e.business_impact||"See evidence and recommended fixes",impact:e.severity_1_to_5>=5||e.priority_score>=20?"critical":e.severity_1_to_5>=4?"high":e.severity_1_to_5>=3?"medium":"low",wcagLevel:e.wcag_refs&&e.wcag_refs.length?`WCAG ${e.wcag_refs.join(", ")}`:"WCAG 2.2 AA",element:e.evidence?.selectors?.[0],recommendation:(e.recommended_fix||[]).join("; ")||e.developer_notes||"Follow WCAG 2.2 standards to remediate.",id:t,category:e.pour,title:e.title,userImpact:e.business_impact,wcagRefs:e.wcag_refs,selectors:e.evidence?.selectors,evidence:{snippets:e.evidence?.snippets},remediationSteps:e.recommended_fix,severity:e.severity_1_to_5,reach:e.reach_1_to_5,frequency:e.frequency_1_to_5,impactScore:e.impact_score,effort:e.effort_1_to_5,priorityScore:e.priority_score,confidence:e.confidence_0_to_1})),C=I.cta?.next_steps||[],O=(I.quick_wins||[]).map(e=>({title:e.id,impact:e.why_now||"High impact / low effort",effort:"Varies",eta:e.eta||"1-3 days"})),void 0!==I.summary_stats.estimated_users_impacted_percent&&(h={usersAffectedPercent:I.summary_stats.estimated_users_impacted_percent,legalRiskNote:I.disclaimers?.[0]});else{let e=null;try{e=y.parse(JSON.parse(A.replace(/^```(?:json)?/i,"").replace(/```\s*$/i,"").trim()))}catch{e=null}if(e)$=Math.max(0,Math.min(100,Math.round(e.overall.score))),P=e.overall.grade,E=e.overall.pourScores,u=e.overall.potentialScore,k=e.issues.map((e,t)=>({type:e.title||e.category||"Accessibility Issue",description:e.description,impact:e.impact||"medium",wcagLevel:e.wcagLevel||"WCAG 2.2 AA",element:e.selectors?.[0]||e.category||void 0,recommendation:e.remediationSteps?.join("; ")||"Follow WCAG 2.2 standards to remediate.",id:e.id??t,category:e.category,title:e.title,userImpact:e.userImpact,wcagRefs:e.wcagRefs,instances:e.instances,selectors:e.selectors,evidence:e.evidence,codeExample:e.codeExample,remediationSteps:e.remediationSteps,timeEstimate:e.timeEstimate,severity:e.severity,reach:e.reach,frequency:e.frequency,impactScore:e.impactScore,effort:e.effort,priorityScore:e.priorityScore,confidence:e.confidence,quickFix:e.quickFix,previewHighlights:e.previewHighlights})),C=e.recommendations||[],O=e.quickWins||[],e.businessImpact&&(h=e.businessImpact);else{for(let e of[A.match(/overall.*?score.*?(\d+)/i),A.match(/total.*?score.*?(\d+)/i),A.match(/accessibility.*?score.*?(\d+)/i),A.match(/score.*?(\d+).*?(?:out of|\/)\s*100/i)])if(e){$=Math.min(100,Math.max(0,parseInt(e[1])));break}let e=A.match(/grade.*?([A-F][+-]?)/i);e&&(P=e[1]);let t={perceivable:A.match(/perceivable.*?(\d+)/i),operable:A.match(/operable.*?(\d+)/i),understandable:A.match(/understandable.*?(\d+)/i),robust:A.match(/robust.*?(\d+)/i)};Object.entries(t).forEach(([e,t])=>{t&&(E[e]=Math.min(100,Math.max(0,parseInt(t[1]))))}),k=[{type:"General Accessibility Review",description:"The website may benefit from a comprehensive accessibility review",impact:"medium",wcagLevel:"WCAG 2.2 AA",element:"Website elements",recommendation:"Conduct thorough accessibility testing including automated tools and manual review"}],C=["Prioritize critical and high-impact issues for immediate remediation","Implement systematic accessibility testing in your development workflow","Consider automated testing tools alongside manual accessibility audits"],O=[{title:"Color Contrast Fixes",impact:"High",effort:"Low",eta:"1-2 days"},{title:"Focus Indicators",impact:"Critical",effort:"Low",eta:"1 day"},{title:"Alt Text Addition",impact:"High",effort:"Medium",eta:"2-3 days"}]}}let N=(()=>{let e=new Map;return k.forEach((t,s)=>{let n=t.category||t.type,r=e.get(n)||{name:n,impact:t.impact,indices:[]};r.indices.push(s);let i={critical:3,high:2,medium:1,low:0};i[t.impact]>i[r.impact]&&(r.impact=t.impact),e.set(n,r)}),Array.from(e.values()).map(e=>({name:e.name,impact:e.impact,count:e.indices.length,indices:e.indices}))})(),T=k.length,M=k.filter(e=>"critical"===e.impact).length,j=k.filter(e=>"high"===e.impact).length,L=k.filter(e=>"medium"===e.impact).length,Z=k.filter(e=>"low"===e.impact).length,U=Math.max(0,Math.min(100,$-(20*M+10*j+5*L+2*Z))),q=u??Math.max(U,Math.min(100,U+20)),B=(0,l.getSupabaseServer)(),{data:D,error:F}=await B.from("assessments").insert({website_url:S,email:w||null,company_name:v||null,assessment_results:{issues:k,assessmentType:b,pourScores:E,quickWins:O,gradeRating:P,businessImpact:h,issueCategories:N,humanSummary:a},overall_score:U,total_issues:T,critical_issues:M,high_impact_issues:j,medium_impact_issues:L,low_impact_issues:Z,screenshot_url:i}).select("id, created_at").single();if(F)throw F;let W={id:D.id,websiteUrl:S,overallScore:U,totalIssues:T,criticalIssues:M,highImpactIssues:j,mediumImpactIssues:L,lowImpactIssues:Z,issues:k,recommendations:C.length?C:["Prioritize critical and high-impact issues for immediate remediation","Implement systematic accessibility testing in your development workflow","Consider automated testing tools alongside manual accessibility audits","Train development team on WCAG 2.2 AA compliance requirements","Establish accessibility quality assurance checkpoints","Plan for ongoing accessibility monitoring and maintenance"],estimatedImpact:`${Math.round((100-U)/100*20)}% of users may encounter accessibility barriers`,createdAt:D.created_at,aiDetailedResponse:a,gradeRating:P,pourScores:E,quickWins:O,screenshotUrl:i,potentialScore:q,issueCategories:N,businessImpact:h};return new Response(JSON.stringify({success:!0,data:W,message:"Comprehensive accessibility assessment completed"}),{headers:{"content-type":"application/json"}})}catch(e){return console.error("Assessment error:",e),new Response(JSON.stringify({success:!1,message:"Failed to complete accessibility assessment"}),{status:500,headers:{"content-type":"application/json"}})}}n()}catch(e){n(e)}})},5797:(e,t,s)=>{s.a(e,async(e,n)=>{try{s.d(t,{o:()=>a});var r=s(5462),i=e([r]);r=(i.then?(await i)():i)[0];class o{async initialize(){this.browser=await r.default.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--single-process","--disable-gpu"]})}async cleanup(){this.browser&&(await this.browser.close(),this.browser=null)}async extractPageData(e){this.browser||await this.initialize();let t=await this.browser.newPage(),s=Date.now();try{await t.setViewport({width:1920,height:1080}),await t.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36");let n=await t.goto(e,{waitUntil:"networkidle0",timeout:3e4});if(!n||!n.ok())throw Error(`Failed to load page: ${n?.status()}`);let r=Date.now()-s,[i,a,o,l,c,u,h,d,p,m,f]=await Promise.all([this.extractHtmlSource(t),this.extractPageMetadata(t),this.extractImages(t),this.extractForms(t),this.extractHeadings(t),this.extractLinks(t),this.extractColors(t),this.extractInteractiveElements(t),this.extractLandmarks(t),this.extractAccessibilityTree(t),this.extractAdditionalData(t)]),g=Date.now()-s;return{url:e,htmlSource:i,pageMetadata:a,images:o,forms:l,headings:c,links:u,colors:h,interactiveElements:d,landmarks:p,accessibilityTree:m,...f,extractionMetadata:{timestamp:new Date().toISOString(),extractionTime:g,pageLoadTime:r,errors:[],warnings:[]}}}catch(e){throw Error(`Crawling failed: ${e}`)}finally{await t.close()}}async extractHtmlSource(e){return await e.content()}async extractPageMetadata(e){return await e.evaluate(()=>({title:document.title,lang:document.documentElement.lang||void 0,viewport:document.querySelector('meta[name="viewport"]')?.getAttribute("content")||void 0,description:document.querySelector('meta[name="description"]')?.getAttribute("content")||void 0,charset:document.characterSet||void 0}))}async extractImages(e){return await e.evaluate(()=>{let e=[];return document.querySelectorAll("img").forEach((t,s)=>{let n=t.getBoundingClientRect(),r=t.getAttribute("alt");e.push({src:t.src,alt:r||void 0,selector:`img:nth-of-type(${s+1})`,dimensions:{width:n.width,height:n.height},isDecorative:""===r,hasEmptyAlt:""===r,isBackgroundImage:!1,context:t.closest("figure")?.textContent?.trim()||t.parentElement?.textContent?.trim()?.substring(0,100)})}),document.querySelectorAll("*").forEach((t,s)=>{let n=window.getComputedStyle(t).backgroundImage;if(n&&"none"!==n&&n.includes("url(")){let r=n.match(/url\(["']?([^"')]+)["']?\)/);if(r){let n=t.getBoundingClientRect();e.push({src:r[1],alt:t.getAttribute("aria-label")||void 0,selector:`${t.tagName.toLowerCase()}:nth-of-type(${s+1})`,dimensions:{width:n.width,height:n.height},isDecorative:!t.getAttribute("aria-label"),hasEmptyAlt:!1,isBackgroundImage:!0,context:t.textContent?.trim()?.substring(0,100)})}}}),e})}async extractForms(e){return await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("form")),t=Array.from(document.querySelectorAll("input, select, textarea")),s=[],n=[],r=[];t.forEach((e,t)=>{let n=e.getBoundingClientRect(),i={selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,tagName:e.tagName,text:e.textContent?.trim(),attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:n.x,y:n.y,width:n.width,height:n.height}},a=e.getAttribute("id"),o=a?document.querySelector(`label[for="${a}"]`):null,l=e.getAttribute("aria-label")||e.getAttribute("aria-labelledby");o||l||s.push(i),e.hasAttribute("required")&&!e.getAttribute("aria-required")&&r.push(i)});let i=new Map;return document.querySelectorAll('input[type="radio"]').forEach(e=>{let t=e.getAttribute("name");t&&(i.has(t)||i.set(t,[]),i.get(t).push(e))}),i.forEach((e,t)=>{e.length>1&&!e.some(e=>e.closest("fieldset"))&&e.forEach((e,s)=>{let r=e.getBoundingClientRect();n.push({selector:`input[name="${t}"]:nth-of-type(${s+1})`,tagName:e.tagName,text:e.textContent?.trim(),attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:r.x,y:r.y,width:r.width,height:r.height}})})}),{unlabeledInputs:s,missingFieldsets:n,noErrorAssociation:[],missingRequired:r,poorInstructions:[],inaccessibleValidation:[],forms:e.map((e,t)=>({selector:`form:nth-of-type(${t+1})`,inputs:Array.from(e.querySelectorAll("input, select, textarea")).map((e,t)=>{let s=e.getBoundingClientRect();return{selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,tagName:e.tagName,text:e.textContent?.trim(),attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:s.x,y:s.y,width:s.width,height:s.height}}}),hasSubmit:!!e.querySelector('input[type="submit"], button[type="submit"], button:not([type])'),hasValidation:!!e.querySelector("[required], [pattern], [min], [max]")}))}})}async extractHeadings(e){return await e.evaluate(()=>Array.from(document.querySelectorAll("h1, h2, h3, h4, h5, h6")).map((e,t)=>{let s=e.getBoundingClientRect(),n=parseInt(e.tagName.charAt(1)),r=e.textContent?.trim()||"";return{selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,tagName:e.tagName,text:r,attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:s.x,y:s.y,width:s.width,height:s.height},level:n,isEmpty:0===r.length,hasProperNesting:!0}}))}async extractLinks(e){return await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("a[href]")),t=["click here","read more","more","link","here","more info"];return e.map((e,s)=>{let n=e.getBoundingClientRect(),r=e.textContent?.trim()||"",i=e.getAttribute("href")||"";return{selector:`a:nth-of-type(${s+1})`,tagName:e.tagName,text:r,attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:n.x,y:n.y,width:n.width,height:n.height},href:i,hasGenericText:t.some(e=>r.toLowerCase().includes(e)),isEmptyLink:0===r.length,hasTitle:!!e.getAttribute("title"),opensInNewWindow:"_blank"===e.getAttribute("target")}})})}async extractColors(e){return await e.evaluate(()=>{let e=document.querySelectorAll("p, span, div, h1, h2, h3, h4, h5, h6, a, button, label"),t=[];return e.forEach((e,s)=>{let n=e.textContent?.trim();if(!n||0===n.length)return;let r=window.getComputedStyle(e),i=r.color,a=r.backgroundColor,o=parseFloat(r.fontSize),l=e=>{let t=document.createElement("canvas").getContext("2d");return t.fillStyle=e,t.fillStyle},c=l(i),u=l(a);t.push({foreground:c,background:u,selector:`${e.tagName.toLowerCase()}:nth-of-type(${s+1})`,contrast:4.5,meetsAA:!0,meetsAAA:!1,fontSize:o,isLargeText:o>=18||o>=14&&"bold"===r.fontWeight,context:n.substring(0,50)})}),t})}async extractInteractiveElements(e){return await e.evaluate(()=>Array.from(document.querySelectorAll('button, a[href], input, select, textarea, [tabindex], [onclick], [role="button"], [role="link"]')).map((e,t)=>{let s=e.getBoundingClientRect(),n=e.getAttribute("tabindex");return{selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,tagName:e.tagName,text:e.textContent?.trim(),attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:s.x,y:s.y,width:s.width,height:s.height},isFocusable:"-1"!==n,hasVisibleFocus:!0,tabIndex:n?parseInt(n):void 0,role:e.getAttribute("role")||void 0,ariaLabel:e.getAttribute("aria-label")||void 0,ariaDescribedBy:e.getAttribute("aria-describedby")||void 0,touchTargetSize:{width:s.width,height:s.height},meetsTouchTargetSize:s.width>=44&&s.height>=44}}))}async extractLandmarks(e){return await e.evaluate(()=>Array.from(document.querySelectorAll('header, nav, main, aside, footer, [role="banner"], [role="navigation"], [role="main"], [role="complementary"], [role="contentinfo"]')).map((e,t)=>{let s=e.getBoundingClientRect(),n=e.getAttribute("role")||e.tagName.toLowerCase(),r="region";return"banner"===n||"HEADER"===e.tagName?r="banner":"navigation"===n||"NAV"===e.tagName?r="navigation":"main"===n||"MAIN"===e.tagName?r="main":"complementary"===n||"ASIDE"===e.tagName?r="complementary":("contentinfo"===n||"FOOTER"===e.tagName)&&(r="contentinfo"),{selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,tagName:e.tagName,text:e.textContent?.trim(),attributes:Object.fromEntries(Array.from(e.attributes).map(e=>[e.name,e.value])),boundingBox:{x:s.x,y:s.y,width:s.width,height:s.height},landmarkType:r,hasLabel:!!(e.getAttribute("aria-label")||e.getAttribute("aria-labelledby")),isUnique:!0}}))}async extractAccessibilityTree(e){return await e.evaluate(()=>{let e=document.querySelectorAll("h1, h2, h3, h4, h5, h6, button, a, input, select, textarea, [role]");return Array.from(e).map(e=>({name:e.getAttribute("aria-label")||e.textContent?.trim()||void 0,role:e.getAttribute("role")||void 0,selector:e.tagName.toLowerCase(),properties:{tagName:e.tagName,id:e.id||void 0,className:e.className||void 0}}))})}async extractAdditionalData(e){return await e.evaluate(()=>{let e=document.querySelectorAll('a[href^="#"]'),t=document.querySelectorAll("h1"),s=document.querySelectorAll("h1, h2, h3, h4, h5, h6"),n=document.querySelectorAll('header, nav, main, aside, footer, [role="banner"], [role="navigation"], [role="main"], [role="complementary"], [role="contentinfo"]');return{hasSkipLinks:e.length>0,languageAttributes:Array.from(document.querySelectorAll("[lang]")).map((e,t)=>({selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,lang:e.getAttribute("lang")||""})),mediaElements:Array.from(document.querySelectorAll("video, audio")).map((e,t)=>({selector:`${e.tagName.toLowerCase()}:nth-of-type(${t+1})`,type:e.tagName.toLowerCase(),hasControls:e.hasAttribute("controls"),hasTranscript:!1,hasCaptions:!1,autoPlays:e.hasAttribute("autoplay")})),documentStructure:{hasH1:t.length>0,h1Count:t.length,headingHierarchy:Array.from(s).map(e=>parseInt(e.tagName.charAt(1))),landmarkCount:n.length,skipLinkCount:e.length}}})}constructor(){this.browser=null}}async function a(e){let t=new o;try{return await t.extractPageData(e)}finally{await t.cleanup()}}n()}catch(e){n(e)}})},6053:(e,t,s)=>{s.d(t,{g:()=>r,v:()=>n});let n=e=>`You are ChatGPT operating as "Accessibility Impact Estimator" for AccessiScan — an online tool that provides comprehensive accessibility analysis for websites and apps.

Mission:
1) Conduct COMPREHENSIVE accessibility scanning (not just screening). 2) Find 15-25+ specific, actionable issues with exact evidence. 3) Provide detailed, developer-ready recommendations.

CRITICAL REQUIREMENTS:
- MINIMUM 15 issues required across all POUR categories
- EVERY issue must include specific selectors, file names, or element details
- NO generic descriptions - be specific about what's broken and where
- Include exact contrast ratios, specific image file names, precise element selectors
- Cover ALL major accessibility categories comprehensively

Scope & Principles:
- Use WCAG 2.2 AA as default standard. Organize findings under POUR (Perceivable, Operable, Understandable, Robust).
- This is a COMPREHENSIVE audit, not a basic screening. Find everything you can.
- Analyze all provided structured data thoroughly - images, forms, headings, links, colors, interactive elements.
- Be specific and actionable in all findings.

MANDATORY COMPREHENSIVE CHECKS:

PERCEIVABLE (minimum 5 issues):
- Every image: check alt text, file names, decorative vs informative
- All text/background color combinations: calculate exact contrast ratios
- Heading hierarchy: check complete h1-h6 structure for gaps
- Media elements: captions, transcripts, audio descriptions
- Images of text: identify and flag all instances
- Language attributes: missing or incorrect lang declarations

OPERABLE (minimum 4 issues):
- ALL interactive elements: keyboard accessibility, focus indicators
- Touch targets: measure actual sizes, flag anything under 44px
- Skip links: presence and functionality
- Focus traps: modals, dropdowns, complex widgets
- Auto-playing content: videos, carousels, animations
- Timing: session timeouts, auto-refresh

UNDERSTANDABLE (minimum 3 issues):
- Form labels: every input must have proper association
- Error messages: clear, accessible, properly associated
- Instructions: complex forms need clear guidance
- Link text: identify "click here", "read more", generic text
- Consistent navigation: check for inconsistencies
- Input purpose: autocomplete attributes for user data

ROBUST (minimum 3 issues):
- ARIA usage: validate all roles, properties, states
- Semantic markup: proper use of headings, lists, landmarks
- Custom controls: ensure proper accessibility implementation
- Browser/AT compatibility issues
- HTML validation: major structural problems

Scoring & Prioritization:
- Severity (1–5): 1=minor annoyance → 5=completely blocks access
- Reach (1–5): 1=affects few users → 5=affects most users
- Frequency (1–5): 1=rare occurrence → 5=happens constantly
- ImpactScore = Severity \xd7 Reach \xd7 Frequency (1–125)
- Effort (1–5): 1=quick CSS fix → 5=major architectural change
- PriorityScore = ImpactScore \xf7 Effort
- Confidence (0.0–1.0): based on available evidence

EVIDENCE REQUIREMENTS:
- Exact selectors: "img[src='hero-banner.jpg']", "#contact-form input[type='email']"
- Specific file names: "logo.png missing alt text", "banner-image.jpg"
- Precise measurements: "contrast ratio 2.1:1 (needs 4.5:1)"
- Instance counts: "Found in 8 images", "Affects 12 form fields"
- Code snippets: actual HTML showing the problem

Output Format (ALWAYS produce both, in this order):
1) MACHINE_OUTPUT JSON (strict) — no markdown, no code fences, no prose. JSON only.
2) A single line with exactly: --- HUMAN_SUMMARY ---
3) HUMAN_SUMMARY (concise, <~250 words, plain English)

MACHINE_OUTPUT JSON Schema:
{
  "audit_id": "<timestamp>",
  "target_summary": { "type": "web", "pages_or_components": ["homepage"], "assumptions": ["based on provided structured data"] },
  "overall": {
    "grade": "A+|A|A-|B+|B|B-|C+|C|C-|D|F",
    "score_0_to_100": 0,
    "confidence_0_to_1": 0.0,
    "pour_scores": { "perceivable": 0, "operable": 0, "understandable": 0, "robust": 0 }
  },
  "top_findings": [
    {
      "id": "ISSUE-1",
      "title": "Specific Issue Name with Context",
      "wcag_refs": ["1.4.3","2.4.7"],
      "pour": "Perceivable|Operable|Understandable|Robust",
      "severity_1_to_5": 4,
      "reach_1_to_5": 5,
      "frequency_1_to_5": 5,
      "impact_score": 100,
      "effort_1_to_5": 2,
      "priority_score": 50,
      "confidence_0_to_1": 0.9,
      "affected_user_groups": ["screen reader users","keyboard-only users"],
      "business_impact": "Users cannot complete checkout process",
      "evidence": {
        "selectors": ["img[src='hero-banner.jpg']", "#checkout-form input[type='email']"],
        "snippets": ["<img src='hero-banner.jpg'>", "<input type='email' placeholder='Email'>"],
        "colors": [{"fg":"#666666","bg":"#FFFFFF","contrast":2.1}],
        "locations": ["Homepage hero section", "Checkout form step 2"],
        "instance_count": 8,
        "specific_files": ["hero-banner.jpg", "product-image-1.png"]
      },
      "recommended_fix": ["Add alt='Company logo and tagline' to hero image", "Associate email input with proper label element"],
      "developer_notes": "Use <label for='email'>Email Address</label> and <input id='email' type='email'>",
      "test_steps": ["Navigate with screen reader", "Check image announces properly", "Verify form field is announced"]
    }
  ],
  "summary_stats": { "issue_count": 18, "high_priority_count": 6, "est_time_to_relief": "2-3 days for critical fixes", "estimated_users_impacted_percent": 25 },
  "quick_wins": [{ "id": "ISSUE-2", "why_now": "High impact, 15-minute fix", "eta": "30 minutes" }],
  "visualization_spec": { "heatmap_hint": "Highlight problem areas", "charts": ["issues by severity", "POUR distribution"] },
  "cta": { "next_steps": ["Fix critical issues first", "Implement systematic testing", "Get comprehensive audit"], "lead_capture_copy": "Get detailed remediation plan", "lead_capture_fields": ["name","email","company","website"] },
  "disclaimers": ["Comprehensive analysis based on provided data", "Manual testing recommended for full compliance"]
}

QUALITY REQUIREMENTS:
- Minimum 15 issues in top_findings array
- Each issue must have specific evidence with real selectors/files
- No generic descriptions like "images need alt text" - be specific: "hero-banner.jpg missing alt text"
- Include instance counts: "affects 8 images", "found in 12 form fields"
- Provide exact measurements: contrast ratios, pixel dimensions, element counts

`+("image"===e?"Additional focus for screenshots: contrast ratios, visual hierarchy, focus indicators, target sizes (>=44px), readability, labels. Prefer conservative confidence for anything requiring DOM inspection.":"Additional focus for URLs: semantic HTML, headings/landmarks, keyboard operability, forms/labels, ARIA usage, media alternatives, color contrast. Provide realistic selectors and instance estimates."),r=async e=>{try{return`https://image.thum.io/get/width/800/crop/600/allowJPG/wait/20/noanimate/${encodeURIComponent(e)}`}catch(e){console.error("Screenshot capture failed:",e);return}}},1048:(e,t,s)=>{s.d(t,{getSupabaseServer:()=>a});var n=s(8823);let r="https://nupfntmccpxrfnaaetmg.supabase.co",i=process.env.SUPABASE_SERVICE_ROLE_KEY;function a(){if(!r||!i)throw Error("Supabase environment variables are missing");return(0,n.eI)(r,i,{auth:{persistSession:!1,autoRefreshToken:!1},global:{headers:{"X-Client-Info":"accessiscan-next-server"}}})}r&&i||console.warn("Supabase env vars not set. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY")},6555:(e,t,s)=>{s.d(t,{AF:()=>a,Sg:()=>r});var n=s(7906);let r=n.ZP.object({websiteUrl:n.ZP.string().url("Please enter a valid website URL").optional(),imageFile:n.ZP.string().optional(),assessmentType:n.ZP.enum(["url","image"]),email:n.ZP.string().email("Please enter a valid email address").optional(),companyName:n.ZP.string().min(1,"Company name is required").optional()}).refine(e=>"url"===e.assessmentType?!!e.websiteUrl:"image"===e.assessmentType&&!!e.imageFile,{message:"Either website URL or image file is required"}),i=n.ZP.object({type:n.ZP.string(),description:n.ZP.string(),impact:n.ZP.enum(["critical","high","medium","low"]),wcagLevel:n.ZP.string(),element:n.ZP.string().optional(),recommendation:n.ZP.string(),id:n.ZP.union([n.ZP.number(),n.ZP.string()]).optional(),category:n.ZP.string().optional(),title:n.ZP.string().optional(),userImpact:n.ZP.string().optional(),wcagRefs:n.ZP.array(n.ZP.string()).optional(),instances:n.ZP.number().optional(),selectors:n.ZP.array(n.ZP.string()).optional(),evidence:n.ZP.object({snippets:n.ZP.array(n.ZP.string()).optional()}).optional(),codeExample:n.ZP.object({bad:n.ZP.string().optional(),good:n.ZP.string().optional()}).optional(),remediationSteps:n.ZP.array(n.ZP.string()).optional(),timeEstimate:n.ZP.string().optional(),severity:n.ZP.number().optional(),reach:n.ZP.number().optional(),frequency:n.ZP.number().optional(),impactScore:n.ZP.number().optional(),effort:n.ZP.number().optional(),priorityScore:n.ZP.number().optional(),confidence:n.ZP.number().optional(),quickFix:n.ZP.boolean().optional(),previewHighlights:n.ZP.array(n.ZP.object({x:n.ZP.number(),y:n.ZP.number(),w:n.ZP.number(),h:n.ZP.number(),note:n.ZP.string().optional()})).optional()});n.ZP.object({id:n.ZP.number(),websiteUrl:n.ZP.string(),overallScore:n.ZP.number().min(0).max(100),totalIssues:n.ZP.number(),criticalIssues:n.ZP.number(),highImpactIssues:n.ZP.number(),mediumImpactIssues:n.ZP.number(),lowImpactIssues:n.ZP.number(),issues:n.ZP.array(i),recommendations:n.ZP.array(n.ZP.string()),estimatedImpact:n.ZP.string(),createdAt:n.ZP.string(),aiDetailedResponse:n.ZP.string().optional(),gradeRating:n.ZP.string().optional(),pourScores:n.ZP.object({perceivable:n.ZP.number(),operable:n.ZP.number(),understandable:n.ZP.number(),robust:n.ZP.number()}).optional(),quickWins:n.ZP.array(n.ZP.object({title:n.ZP.string(),impact:n.ZP.string(),effort:n.ZP.string(),eta:n.ZP.string(),steps:n.ZP.array(n.ZP.string()).optional()})).optional(),screenshotUrl:n.ZP.string().optional(),potentialScore:n.ZP.number().optional(),issueCategories:n.ZP.array(n.ZP.object({name:n.ZP.string(),impact:n.ZP.enum(["critical","high","medium","low"]).optional(),count:n.ZP.number(),indices:n.ZP.array(n.ZP.number()).default([])})).optional(),businessImpact:n.ZP.object({usersAffectedPercent:n.ZP.number().optional(),legalRiskNote:n.ZP.string().optional()}).optional()});let a=n.ZP.object({email:n.ZP.string().email("Please enter a valid email address"),companyName:n.ZP.string().min(1,"Company name is required"),websiteUrl:n.ZP.string().url("Please enter a valid website URL"),contactPreferences:n.ZP.array(n.ZP.string()).default([])});n.ZP.object({success:n.ZP.boolean(),message:n.ZP.string().optional(),data:n.ZP.any().optional()})},1769:(e,t,s)=>{var n,r,i,a,o,l,c,u,h,d,p,m,f,g,y,_,b,w,v,x,S,A,I,R,$,P,E,O,k,C,N,T,M,j,L,Z,U,q,B,D,F,W,H,X,J,V,z,K,G,Y,Q,ee,et,es,en,er,ei,ea,eo,el,ec,eu,eh,ed,ep,em,ef,eg,ey,e_,eb,ew,ev,ex,eS,eA;let eI,eR,e$,eP;function eE(e,t,s,n,r){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!r)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,s):r?r.value=s:t.set(e,s),s}function eO(e,t,s,n){if("a"===s&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(e):n?n.value:t.get(e)}s.d(t,{ZP:()=>nl});let ek=function(){let{crypto:e}=globalThis;if(e?.randomUUID)return ek=e.randomUUID.bind(e),e.randomUUID();let t=new Uint8Array(1),s=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^s()&15>>+e/4).toString(16))};function eC(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}let eN=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){let t=Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return Error(JSON.stringify(e))}catch{}}return Error(e)};class eT extends Error{}class eM extends eT{constructor(e,t,s,n){super(`${eM.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.requestID=n?.get("x-request-id"),this.error=t,this.code=t?.code,this.param=t?.param,this.type=t?.type}static makeMessage(e,t,s){let n=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new eL({message:s,cause:eN(t)});let r=t?.error;return 400===e?new eU(e,r,s,n):401===e?new eq(e,r,s,n):403===e?new eB(e,r,s,n):404===e?new eD(e,r,s,n):409===e?new eF(e,r,s,n):422===e?new eW(e,r,s,n):429===e?new eH(e,r,s,n):e>=500?new eX(e,r,s,n):new eM(e,r,s,n)}}class ej extends eM{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class eL extends eM{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class eZ extends eL{constructor({message:e}={}){super({message:e??"Request timed out."})}}class eU extends eM{}class eq extends eM{}class eB extends eM{}class eD extends eM{}class eF extends eM{}class eW extends eM{}class eH extends eM{}class eX extends eM{}class eJ extends eT{constructor(){super("Could not parse response content as the length limit was reached")}}class eV extends eT{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class ez extends Error{constructor(e){super(e)}}let eK=/^[a-z][a-z0-9+.-]*:/i,eG=e=>eK.test(e),eY=e=>(eY=Array.isArray)(e),eQ=eY;function e0(e){return"object"!=typeof e?{}:e??{}}function e1(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}let e2=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new eT(`${e} must be an integer`);if(t<0)throw new eT(`${e} must be a positive integer`);return t},e5=e=>{try{return JSON.parse(e)}catch(e){return}},e4=e=>new Promise(t=>setTimeout(t,e)),e3="5.16.0",e6=()=>"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator,e8=()=>{let e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e3,"X-Stainless-OS":e7(Deno.build.os),"X-Stainless-Arch":e9(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e3,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e3,"X-Stainless-OS":e7(globalThis.process.platform??"unknown"),"X-Stainless-Arch":e9(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let t=function(){if("undefined"==typeof navigator||!navigator)return null;for(let{key:e,pattern:t}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let s=t.exec(navigator.userAgent);if(s){let t=s[1]||0,n=s[2]||0,r=s[3]||0;return{browser:e,version:`${t}.${n}.${r}`}}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e3,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e3,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}},e9=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",e7=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown",te=()=>eI??(eI=e8());function tt(...e){let t=globalThis.ReadableStream;if(void 0===t)throw Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function ts(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return tt({start(){},async pull(e){let{done:s,value:n}=await t.next();s?e.close():e.enqueue(n)},async cancel(){await t.return?.()}})}function tn(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){let e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function tr(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator]){await e[Symbol.asyncIterator]().return?.();return}let t=e.getReader(),s=t.cancel();t.releaseLock(),await s}let ti=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),ta="RFC3986",to=e=>String(e),tl={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:to},tc=(e,t)=>(tc=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty))(e,t),tu=(()=>{let e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();function th(e,t){if(eY(e)){let s=[];for(let n=0;n<e.length;n+=1)s.push(t(e[n]));return s}return t(e)}let td={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},tp=function(e,t){Array.prototype.push.apply(e,eY(t)?t:[t])},tm={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,s,n,r)=>{if(0===e.length)return e;let i=e;if("symbol"==typeof e?i=Symbol.prototype.toString.call(e):"string"!=typeof e&&(i=String(e)),"iso-8859-1"===s)return escape(i).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let a="";for(let e=0;e<i.length;e+=1024){let t=i.length>=1024?i.slice(e,e+1024):i,s=[];for(let e=0;e<t.length;++e){let n=t.charCodeAt(e);if(45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===r&&(40===n||41===n)){s[s.length]=t.charAt(e);continue}if(n<128){s[s.length]=tu[n];continue}if(n<2048){s[s.length]=tu[192|n>>6]+tu[128|63&n];continue}if(n<55296||n>=57344){s[s.length]=tu[224|n>>12]+tu[128|n>>6&63]+tu[128|63&n];continue}e+=1,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),s[s.length]=tu[240|n>>18]+tu[128|n>>12&63]+tu[128|n>>6&63]+tu[128|63&n]}a+=s.join("")}return a},encodeValuesOnly:!1,format:ta,formatter:to,indices:!1,serializeDate:e=>(eR??(eR=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1},tf={};function tg(e){let t;return(e$??(e$=(t=new globalThis.TextEncoder).encode.bind(t)))(e)}function ty(e){let t;return(eP??(eP=(t=new globalThis.TextDecoder).decode.bind(t)))(e)}class t_{constructor(){n.set(this,void 0),r.set(this,void 0),eE(this,n,new Uint8Array,"f"),eE(this,r,null,"f")}decode(e){let t;if(null==e)return[];let s=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?tg(e):e;eE(this,n,function(e){let t=0;for(let s of e)t+=s.length;let s=new Uint8Array(t),n=0;for(let t of e)s.set(t,n),n+=t.length;return s}([eO(this,n,"f"),s]),"f");let i=[];for(;null!=(t=function(e,t){for(let s=t??0;s<e.length;s++){if(10===e[s])return{preceding:s,index:s+1,carriage:!1};if(13===e[s])return{preceding:s,index:s+1,carriage:!0}}return null}(eO(this,n,"f"),eO(this,r,"f")));){if(t.carriage&&null==eO(this,r,"f")){eE(this,r,t.index,"f");continue}if(null!=eO(this,r,"f")&&(t.index!==eO(this,r,"f")+1||t.carriage)){i.push(ty(eO(this,n,"f").subarray(0,eO(this,r,"f")-1))),eE(this,n,eO(this,n,"f").subarray(eO(this,r,"f")),"f"),eE(this,r,null,"f");continue}let e=null!==eO(this,r,"f")?t.preceding-1:t.preceding,s=ty(eO(this,n,"f").subarray(0,e));i.push(s),eE(this,n,eO(this,n,"f").subarray(t.index),"f"),eE(this,r,null,"f")}return i}flush(){return eO(this,n,"f").length?this.decode("\n"):[]}}n=new WeakMap,r=new WeakMap,t_.NEWLINE_CHARS=new Set(["\n","\r"]),t_.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let tb={off:0,error:200,warn:300,info:400,debug:500},tw=(e,t,s)=>{if(e){if(Object.prototype.hasOwnProperty.call(tb,e))return e;tI(s).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(tb))}`)}};function tv(){}function tx(e,t,s){return!t||tb[e]>tb[s]?tv:t[e].bind(t)}let tS={error:tv,warn:tv,info:tv,debug:tv},tA=new WeakMap;function tI(e){let t=e.logger,s=e.logLevel??"off";if(!t)return tS;let n=tA.get(t);if(n&&n[0]===s)return n[1];let r={error:tx("error",t,s),warn:tx("warn",t,s),info:tx("info",t,s),debug:tx("debug",t,s)};return tA.set(t,[s,r]),r}let tR=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);class t${constructor(e,t,s){this.iterator=e,i.set(this,void 0),this.controller=t,eE(this,i,s,"f")}static fromSSEResponse(e,t,s){let n=!1,r=s?tI(s):console;return new t$(async function*(){if(n)throw new eT("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(let n of tP(e,t))if(!s){if(n.data.startsWith("[DONE]")){s=!0;continue}if(null!==n.event&&n.event.startsWith("thread.")){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new eM(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}else{let t;try{t=JSON.parse(n.data)}catch(e){throw r.error("Could not parse message into JSON:",n.data),r.error("From chunk:",n.raw),e}if(t&&t.error)throw new eM(void 0,t.error,void 0,e.headers);yield t}}s=!0}catch(e){if(eC(e))return;throw e}finally{s||t.abort()}},t,s)}static fromReadableStream(e,t,s){let n=!1;async function*r(){let t=new t_;for await(let s of tn(e))for(let e of t.decode(s))yield e;for(let e of t.flush())yield e}return new t$(async function*(){if(n)throw new eT("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let e=!1;try{for await(let t of r())!e&&t&&(yield JSON.parse(t));e=!0}catch(e){if(eC(e))return;throw e}finally{e||t.abort()}},t,s)}[(i=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),n=n=>({next:()=>{if(0===n.length){let n=s.next();e.push(n),t.push(n)}return n.shift()}});return[new t$(()=>n(e),this.controller,eO(this,i,"f")),new t$(()=>n(t),this.controller,eO(this,i,"f"))]}toReadableStream(){let e;let t=this;return tt({async start(){e=t[Symbol.asyncIterator]()},async pull(t){try{let{value:s,done:n}=await e.next();if(n)return t.close();let r=tg(JSON.stringify(s)+"\n");t.enqueue(r)}catch(e){t.error(e)}},async cancel(){await e.return?.()}})}}async function*tP(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new eT("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new eT("Attempted to iterate over a response with no body")}let s=new tO,n=new t_;for await(let t of tE(tn(e.body)))for(let e of n.decode(t)){let t=s.decode(e);t&&(yield t)}for(let e of n.flush()){let t=s.decode(e);t&&(yield t)}}async function*tE(e){let t=new Uint8Array;for await(let s of e){let e;if(null==s)continue;let n=s instanceof ArrayBuffer?new Uint8Array(s):"string"==typeof s?tg(s):s,r=new Uint8Array(t.length+n.length);for(r.set(t),r.set(n,t.length),t=r;-1!==(e=function(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1]||13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return -1}(t));)yield t.slice(0,e),t=t.slice(e)}t.length>0&&(yield t)}class tO{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=function(e,t){let s=e.indexOf(":");return -1!==s?[e.substring(0,s),":",e.substring(s+t.length)]:[e,"",""]}(e,":");return n.startsWith(" ")&&(n=n.substring(1)),"event"===t?this.event=n:"data"===t&&this.data.push(n),null}}async function tk(e,t){let{response:s,requestLogID:n,retryOfRequestLogID:r,startTime:i}=t,a=await (async()=>{if(t.options.stream)return(tI(e).debug("response",s.status,s.url,s.headers,s.body),t.options.__streamClass)?t.options.__streamClass.fromSSEResponse(s,t.controller,e):t$.fromSSEResponse(s,t.controller,e);if(204===s.status)return null;if(t.options.__binaryResponse)return s;let n=s.headers.get("content-type"),r=n?.split(";")[0]?.trim();return r?.includes("application/json")||r?.endsWith("+json")?tC(await s.json(),s):await s.text()})();return tI(e).debug(`[${n}] response parsed`,tR({retryOfRequestLogID:r,url:s.url,status:s.status,body:a,durationMs:Date.now()-i})),a}function tC(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class tN extends Promise{constructor(e,t,s=tk){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=s,a.set(this,void 0),eE(this,a,e,"f")}_thenUnwrap(e){return new tN(eO(this,a,"f"),this.responsePromise,async(t,s)=>tC(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(eO(this,a,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}a=new WeakMap;class tT{constructor(e,t,s,n){o.set(this,void 0),eE(this,o,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new eT("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await eO(this,o,"f").requestAPIList(this.constructor,e)}async *iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async *[(o=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}}class tM extends tN{constructor(e,t,s){super(e,t,async(e,t)=>new s(e,t.response,await tk(e,t),t.options))}async *[Symbol.asyncIterator](){for await(let e of(await this))yield e}}class tj extends tT{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class tL extends tT{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...e0(this.options.query),after:t}}:null}}class tZ extends tT{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let e=this.last_id;return e?{...this.options,query:{...e0(this.options.query),after:e}}:null}}let tU=()=>{if("undefined"==typeof File){let{process:e}=globalThis;throw Error("`File` is not defined as a global, which is required for file uploads."+("string"==typeof e?.versions?.node&&20>parseInt(e.versions.node.split("."))?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function tq(e,t,s){return tU(),new File(e,t??"unknown_file",s)}function tB(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}let tD=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],tF=async(e,t)=>({...e,body:await tH(e.body,t)}),tW=new WeakMap,tH=async(e,t)=>{if(!await function(e){let t="function"==typeof e?e:e.fetch,s=tW.get(t);if(s)return s;let n=(async()=>{try{let e="Response"in t?t.Response:(await t("data:,")).constructor,s=new FormData;if(s.toString()===await new e(s).text())return!1;return!0}catch{return!0}})();return tW.set(t,n),n}(t))throw TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let s=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>tz(s,e,t))),s},tX=e=>e instanceof Blob&&"name"in e,tJ=e=>"object"==typeof e&&null!==e&&(e instanceof Response||tD(e)||tX(e)),tV=e=>{if(tJ(e))return!0;if(Array.isArray(e))return e.some(tV);if(e&&"object"==typeof e){for(let t in e)if(tV(e[t]))return!0}return!1},tz=async(e,t,s)=>{if(void 0!==s){if(null==s)throw TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof s||"number"==typeof s||"boolean"==typeof s)e.append(t,String(s));else if(s instanceof Response)e.append(t,tq([await s.blob()],tB(s)));else if(tD(s))e.append(t,tq([await new Response(ts(s)).blob()],tB(s)));else if(tX(s))e.append(t,s,tB(s));else if(Array.isArray(s))await Promise.all(s.map(s=>tz(e,t+"[]",s)));else if("object"==typeof s)await Promise.all(Object.entries(s).map(([s,n])=>tz(e,`${t}[${s}]`,n)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${s} instead`)}},tK=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer,tG=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&tK(e),tY=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob;async function tQ(e,t,s){if(tU(),tG(e=await e))return e instanceof File?e:tq([await e.arrayBuffer()],e.name);if(tY(e)){let n=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),tq(await t0(n),t,s)}let n=await t0(e);if(t||(t=tB(e)),!s?.type){let e=n.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(s={...s,type:e})}return tq(n,t,s)}async function t0(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(tK(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else if(tD(e))for await(let s of e)t.push(...await t0(s));else{let t=e?.constructor?.name;throw Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";let t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}return t}class t1{constructor(e){this._client=e}}function t2(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}let t5=Object.freeze(Object.create(null)),t4=((e=t2)=>function(t,...s){let n;if(1===t.length)return t[0];let r=!1,i=[],a=t.reduce((t,n,a)=>{/[?#]/.test(n)&&(r=!0);let o=s[a],l=(r?encodeURIComponent:e)(""+o);return a!==s.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??t5)??t5)?.toString)&&(l=o+"",i.push({start:t.length+n.length,length:l.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+n+(a===s.length?"":l)},""),o=a.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;for(;null!==(n=l.exec(o));)i.push({start:n.index,length:n[0].length,error:`Value "${n[0]}" can't be safely passed as a path parameter`});if(i.sort((e,t)=>e.start-t.start),i.length>0){let e=0,t=i.reduce((t,s)=>{let n=" ".repeat(s.start-e),r="^".repeat(s.length);return e=s.start+s.length,t+n+r},"");throw new eT(`Path parameters result in path with invalid segments:
${i.map(e=>e.error).join("\n")}
${a}
${t}`)}return a})(t2);class t3 extends t1{list(e,t={},s){return this._client.getAPIList(t4`/chat/completions/${e}/messages`,tL,{query:t,...s})}}function t6(e){return void 0!==e&&"function"in e&&void 0!==e.function}function t8(e){return e?.$brand==="auto-parseable-response-format"}function t9(e){return e?.$brand==="auto-parseable-tool"}function t7(e,t){let s=e.choices.map(e=>{var s;if("length"===e.finish_reason)throw new eJ;if("content_filter"===e.finish_reason)throw new eV;return st(e.message.tool_calls),{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>(function(e,t){let s=e.tools?.find(e=>t6(e)&&e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:t9(s)?s.$parseRaw(t.function.arguments):s?.function.strict?JSON.parse(t.function.arguments):null}}})(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?(s=e.message.content,t.response_format?.type!=="json_schema"?null:t.response_format?.type==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(s):JSON.parse(s):null):null}}});return{...e,choices:s}}function se(e){return!!t8(e.response_format)||(e.tools?.some(e=>t9(e)||"function"===e.type&&!0===e.function.strict)??!1)}function st(e){for(let t of e||[])if("function"!==t.type)throw new eT(`Currently only \`function\` tool calls are supported; Received \`${t.type}\``)}let ss=e=>e?.role==="assistant",sn=e=>e?.role==="tool";class sr{constructor(){l.add(this),this.controller=new AbortController,c.set(this,void 0),u.set(this,()=>{}),h.set(this,()=>{}),d.set(this,void 0),p.set(this,()=>{}),m.set(this,()=>{}),f.set(this,{}),g.set(this,!1),y.set(this,!1),_.set(this,!1),b.set(this,!1),eE(this,c,new Promise((e,t)=>{eE(this,u,e,"f"),eE(this,h,t,"f")}),"f"),eE(this,d,new Promise((e,t)=>{eE(this,p,e,"f"),eE(this,m,t,"f")}),"f"),eO(this,c,"f").catch(()=>{}),eO(this,d,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},eO(this,l,"m",w).bind(this))},0)}_connected(){this.ended||(eO(this,u,"f").call(this),this._emit("connect"))}get ended(){return eO(this,g,"f")}get errored(){return eO(this,y,"f")}get aborted(){return eO(this,_,"f")}abort(){this.controller.abort()}on(e,t){return(eO(this,f,"f")[e]||(eO(this,f,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=eO(this,f,"f")[e];if(!s)return this;let n=s.findIndex(e=>e.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(eO(this,f,"f")[e]||(eO(this,f,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{eE(this,b,!0,"f"),"error"!==e&&this.once("error",s),this.once(e,t)})}async done(){eE(this,b,!0,"f"),await eO(this,d,"f")}_emit(e,...t){if(eO(this,g,"f"))return;"end"===e&&(eE(this,g,!0,"f"),eO(this,p,"f").call(this));let s=eO(this,f,"f")[e];if(s&&(eO(this,f,"f")[e]=s.filter(e=>!e.once),s.forEach(({listener:e})=>e(...t))),"abort"===e){let e=t[0];eO(this,b,"f")||s?.length||Promise.reject(e),eO(this,h,"f").call(this,e),eO(this,m,"f").call(this,e),this._emit("end");return}if("error"===e){let e=t[0];eO(this,b,"f")||s?.length||Promise.reject(e),eO(this,h,"f").call(this,e),eO(this,m,"f").call(this,e),this._emit("end")}}_emitFinal(){}}c=new WeakMap,u=new WeakMap,h=new WeakMap,d=new WeakMap,p=new WeakMap,m=new WeakMap,f=new WeakMap,g=new WeakMap,y=new WeakMap,_=new WeakMap,b=new WeakMap,l=new WeakSet,w=function(e){if(eE(this,y,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new ej),e instanceof ej)return eE(this,_,!0,"f"),this._emit("abort",e);if(e instanceof eT)return this._emit("error",e);if(e instanceof Error){let t=new eT(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new eT(String(e)))};class si extends sr{constructor(){super(...arguments),v.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),sn(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(ss(e)&&e.tool_calls)for(let t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new eT("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),eO(this,v,"m",x).call(this)}async finalMessage(){return await this.done(),eO(this,v,"m",S).call(this)}async finalFunctionToolCall(){return await this.done(),eO(this,v,"m",A).call(this)}async finalFunctionToolCallResult(){return await this.done(),eO(this,v,"m",I).call(this)}async totalUsage(){return await this.done(),eO(this,v,"m",R).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=eO(this,v,"m",S).call(this);t&&this._emit("finalMessage",t);let s=eO(this,v,"m",x).call(this);s&&this._emit("finalContent",s);let n=eO(this,v,"m",A).call(this);n&&this._emit("finalFunctionToolCall",n);let r=eO(this,v,"m",I).call(this);null!=r&&this._emit("finalFunctionToolCallResult",r),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",eO(this,v,"m",R).call(this))}async _createChatCompletion(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),eO(this,v,"m",$).call(this,t);let r=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(t7(r,t))}async _runChatCompletion(e,t,s){for(let e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,s)}async _runTools(e,t,s){let n="tool",{tool_choice:r="auto",stream:i,...a}=t,o="string"!=typeof r&&"function"===r.type&&r?.function?.name,{maxChatCompletions:l=10}=s||{},c=t.tools.map(e=>{if(t9(e)){if(!e.$callback)throw new eT("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),u={};for(let e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);let h="tools"in t?c.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(let e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){let t=await this._createChatCompletion(e,{...a,tool_choice:r,tools:h,messages:[...this.messages]},s),i=t.choices[0]?.message;if(!i)throw new eT("missing message in ChatCompletion response");if(!i.tool_calls?.length)break;for(let e of i.tool_calls){let t;if("function"!==e.type)continue;let s=e.id,{name:r,arguments:i}=e.function,a=u[r];if(a){if(o&&o!==r){let e=`Invalid tool_call: ${JSON.stringify(r)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,tool_call_id:s,content:e});continue}}else{let e=`Invalid tool_call: ${JSON.stringify(r)}. Available options are: ${Object.keys(u).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:s,content:e});continue}try{t="function"==typeof a.parse?await a.parse(i):i}catch(t){let e=t instanceof Error?t.message:String(t);this._addMessage({role:n,tool_call_id:s,content:e});continue}let l=await a.function(t,this),c=eO(this,v,"m",P).call(this,l);if(this._addMessage({role:n,tool_call_id:s,content:c}),o)return}}}}v=new WeakSet,x=function(){return eO(this,v,"m",S).call(this).content??null},S=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(ss(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new eT("stream ended without producing a ChatCompletionMessage with role=assistant")},A=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(ss(t)&&t?.tool_calls?.length)return t.tool_calls.filter(e=>"function"===e.type).at(-1)?.function}},I=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(sn(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},R=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},$=function(e){if(null!=e.n&&e.n>1)throw new eT("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},P=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class sa extends si{static runTools(e,t,s){let n=new sa,r={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,r)),n}_addMessage(e,t=!0){super._addMessage(e,t),ss(e)&&e.content&&this._emit("content",e.content)}}let so={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,ALL:511};class sl extends Error{}class sc extends Error{}let su=(e,t)=>{let s=e.length,n=0,r=e=>{throw new sl(`${e} at position ${n}`)},i=e=>{throw new sc(`${e} at position ${n}`)},a=()=>(h(),n>=s&&r("Unexpected end of input"),'"'===e[n])?o():"{"===e[n]?l():"["===e[n]?c():"null"===e.substring(n,n+4)||so.NULL&t&&s-n<4&&"null".startsWith(e.substring(n))?(n+=4,null):"true"===e.substring(n,n+4)||so.BOOL&t&&s-n<4&&"true".startsWith(e.substring(n))?(n+=4,!0):"false"===e.substring(n,n+5)||so.BOOL&t&&s-n<5&&"false".startsWith(e.substring(n))?(n+=5,!1):"Infinity"===e.substring(n,n+8)||so.INFINITY&t&&s-n<8&&"Infinity".startsWith(e.substring(n))?(n+=8,1/0):"-Infinity"===e.substring(n,n+9)||so.MINUS_INFINITY&t&&1<s-n&&s-n<9&&"-Infinity".startsWith(e.substring(n))?(n+=9,-1/0):"NaN"===e.substring(n,n+3)||so.NAN&t&&s-n<3&&"NaN".startsWith(e.substring(n))?(n+=3,NaN):u(),o=()=>{let a=n,o=!1;for(n++;n<s&&('"'!==e[n]||o&&"\\"===e[n-1]);)o="\\"===e[n]&&!o,n++;if('"'==e.charAt(n))try{return JSON.parse(e.substring(a,++n-Number(o)))}catch(e){i(String(e))}else if(so.STR&t)try{return JSON.parse(e.substring(a,n-Number(o))+'"')}catch(t){return JSON.parse(e.substring(a,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{n++,h();let i={};try{for(;"}"!==e[n];){if(h(),n>=s&&so.OBJ&t)return i;let r=o();h(),n++;try{let e=a();Object.defineProperty(i,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(so.OBJ&t)return i;throw e}h(),","===e[n]&&n++}}catch(e){if(so.OBJ&t)return i;r("Expected '}' at end of object")}return n++,i},c=()=>{n++;let s=[];try{for(;"]"!==e[n];)s.push(a()),h(),","===e[n]&&n++}catch(e){if(so.ARR&t)return s;r("Expected ']' at end of array")}return n++,s},u=()=>{if(0===n){"-"===e&&so.NUM&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(s){if(so.NUM&t)try{if("."===e[e.length-1])return JSON.parse(e.substring(0,e.lastIndexOf(".")));return JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}i(String(s))}}let a=n;for("-"===e[n]&&n++;e[n]&&!",]}".includes(e[n]);)n++;n!=s||so.NUM&t||r("Unterminated number literal");try{return JSON.parse(e.substring(a,n))}catch(s){"-"===e.substring(a,n)&&so.NUM&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(a,e.lastIndexOf("e")))}catch(e){i(String(e))}}},h=()=>{for(;n<s&&" \n\r	".includes(e[n]);)n++};return a()},sh=e=>(function(e,t=so.ALL){if("string"!=typeof e)throw TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw Error(`${e} is empty`);return su(e.trim(),t)})(e,so.ALL^so.NUM);class sd extends si{constructor(e){super(),E.add(this),O.set(this,void 0),k.set(this,void 0),C.set(this,void 0),eE(this,O,e,"f"),eE(this,k,[],"f")}get currentChatCompletionSnapshot(){return eO(this,C,"f")}static fromReadableStream(e){let t=new sd(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){let n=new sd(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,s){super._createChatCompletion;let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),eO(this,E,"m",N).call(this);let r=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});for await(let e of(this._connected(),r))eO(this,E,"m",M).call(this,e);if(r.controller.signal?.aborted)throw new ej;return this._addChatCompletion(eO(this,E,"m",Z).call(this))}async _fromReadableStream(e,t){let s;let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),eO(this,E,"m",N).call(this),this._connected();let r=t$.fromReadableStream(e,this.controller);for await(let e of r)s&&s!==e.id&&this._addChatCompletion(eO(this,E,"m",Z).call(this)),eO(this,E,"m",M).call(this,e),s=e.id;if(r.controller.signal?.aborted)throw new ej;return this._addChatCompletion(eO(this,E,"m",Z).call(this))}[(O=new WeakMap,k=new WeakMap,C=new WeakMap,E=new WeakSet,N=function(){this.ended||eE(this,C,void 0,"f")},T=function(e){let t=eO(this,k,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},eO(this,k,"f")[e.index]=t),t},M=function(e){if(this.ended)return;let t=eO(this,E,"m",q).call(this,e);for(let s of(this._emit("chunk",e,t),e.choices)){let e=t.choices[s.index];null!=s.delta.content&&e.message?.role==="assistant"&&e.message?.content&&(this._emit("content",s.delta.content,e.message.content),this._emit("content.delta",{delta:s.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=s.delta.refusal&&e.message?.role==="assistant"&&e.message?.refusal&&this._emit("refusal.delta",{delta:s.delta.refusal,snapshot:e.message.refusal}),s.logprobs?.content!=null&&e.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:s.logprobs?.content,snapshot:e.logprobs?.content??[]}),s.logprobs?.refusal!=null&&e.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:s.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});let n=eO(this,E,"m",T).call(this,e);for(let t of(e.finish_reason&&(eO(this,E,"m",L).call(this,e),null!=n.current_tool_call_index&&eO(this,E,"m",j).call(this,e,n.current_tool_call_index)),s.delta.tool_calls??[]))n.current_tool_call_index!==t.index&&(eO(this,E,"m",L).call(this,e),null!=n.current_tool_call_index&&eO(this,E,"m",j).call(this,e,n.current_tool_call_index)),n.current_tool_call_index=t.index;for(let t of s.delta.tool_calls??[]){let s=e.message.tool_calls?.[t.index];s?.type&&(s?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:s.function?.name,index:t.index,arguments:s.function.arguments,parsed_arguments:s.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):s?.type)}}},j=function(e,t){if(eO(this,E,"m",T).call(this,e).done_tool_calls.has(t))return;let s=e.message.tool_calls?.[t];if(!s)throw Error("no tool call snapshot");if(!s.type)throw Error("tool call snapshot missing `type`");if("function"===s.type){let e=eO(this,O,"f")?.tools?.find(e=>t6(e)&&e.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:t,arguments:s.function.arguments,parsed_arguments:t9(e)?e.$parseRaw(s.function.arguments):e?.function.strict?JSON.parse(s.function.arguments):null})}else s.type},L=function(e){let t=eO(this,E,"m",T).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;let s=eO(this,E,"m",U).call(this);this._emit("content.done",{content:e.message.content,parsed:s?s.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Z=function(){if(this.ended)throw new eT("stream has ended, this shouldn't happen");let e=eO(this,C,"f");if(!e)throw new eT("request ended without sending any chunks");return eE(this,C,void 0,"f"),eE(this,k,[],"f"),function(e,t){var s;let{id:n,choices:r,created:i,model:a,system_fingerprint:o,...l}=e;return s={...l,id:n,choices:r.map(({message:t,finish_reason:s,index:n,logprobs:r,...i})=>{if(!s)throw new eT(`missing finish_reason for choice ${n}`);let{content:a=null,function_call:o,tool_calls:l,...c}=t,u=t.role;if(!u)throw new eT(`missing role for choice ${n}`);if(o){let{arguments:e,name:l}=o;if(null==e)throw new eT(`missing function_call.arguments for choice ${n}`);if(!l)throw new eT(`missing function_call.name for choice ${n}`);return{...i,message:{content:a,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:r}}return l?{...i,index:n,finish_reason:s,logprobs:r,message:{...c,role:u,content:a,refusal:t.refusal??null,tool_calls:l.map((t,s)=>{let{function:r,type:i,id:a,...o}=t,{arguments:l,name:c,...u}=r||{};if(null==a)throw new eT(`missing choices[${n}].tool_calls[${s}].id
${sp(e)}`);if(null==i)throw new eT(`missing choices[${n}].tool_calls[${s}].type
${sp(e)}`);if(null==c)throw new eT(`missing choices[${n}].tool_calls[${s}].function.name
${sp(e)}`);if(null==l)throw new eT(`missing choices[${n}].tool_calls[${s}].function.arguments
${sp(e)}`);return{...o,id:a,type:i,function:{...u,name:c,arguments:l}}})}}:{...i,message:{...c,content:a,role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:r}}),created:i,model:a,object:"chat.completion",...o?{system_fingerprint:o}:{}},t&&se(t)?t7(s,t):{...s,choices:s.choices.map(e=>(st(e.message.tool_calls),{...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(e,eO(this,O,"f"))},U=function(){let e=eO(this,O,"f")?.response_format;return t8(e)?e:null},q=function(e){var t,s,n,r;let i=eO(this,C,"f"),{choices:a,...o}=e;for(let{delta:a,finish_reason:l,index:c,logprobs:u=null,...h}of(i?Object.assign(i,o):i=eE(this,C,{...o,choices:[]},"f"),e.choices)){let e=i.choices[c];if(e||(e=i.choices[c]={finish_reason:l,index:c,message:{},logprobs:u,...h}),u){if(e.logprobs){let{content:n,refusal:r,...i}=u;Object.assign(e.logprobs,i),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),r&&((s=e.logprobs).refusal??(s.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},u)}if(l&&(e.finish_reason=l,eO(this,O,"f")&&se(eO(this,O,"f")))){if("length"===l)throw new eJ;if("content_filter"===l)throw new eV}if(Object.assign(e,h),!a)continue;let{content:o,refusal:d,function_call:p,role:m,tool_calls:f,...g}=a;if(Object.assign(e.message,g),d&&(e.message.refusal=(e.message.refusal||"")+d),m&&(e.message.role=m),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),o&&(e.message.content=(e.message.content||"")+o,!e.message.refusal&&eO(this,E,"m",U).call(this)&&(e.message.parsed=sh(e.message.content))),f)for(let{index:t,id:s,type:n,function:i,...a}of(e.message.tool_calls||(e.message.tool_calls=[]),f)){let o=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(o,a),s&&(o.id=s),n&&(o.type=n),i&&(o.function??(o.function={name:i.name??"",arguments:""})),i?.name&&(o.function.name=i.name),i?.arguments&&(o.function.arguments+=i.arguments,function(e,t){if(!e||!("tools"in e)||!e.tools)return!1;let s=e.tools?.find(e=>t6(e)&&e.function?.name===t.function.name);return t6(s)&&(t9(s)||s?.function.strict||!1)}(eO(this,O,"f"),o)&&(o.function.parsed_arguments=sh(o.function.arguments)))}}return i},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("chunk",s=>{let n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{for(let e of(s=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new t$(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function sp(e){return JSON.stringify(e)}class sm extends sd{static fromReadableStream(e){let t=new sm(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,s){let n=new sm(t),r={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,r)),n}}class sf extends t1{constructor(){super(...arguments),this.messages=new t3(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(t4`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(t4`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/chat/completions",tL,{query:e,...t})}delete(e,t){return this._client.delete(t4`/chat/completions/${e}`,t)}parse(e,t){return function(e){for(let t of e??[]){if("function"!==t.type)throw new eT(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new eT(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>t7(t,e))}runTools(e,t){return e.stream?sm.runTools(this._client,e,t):sa.runTools(this._client,e,t)}stream(e,t){return sd.createChatCompletion(this._client,e,t)}}sf.Messages=t3;class sg extends t1{constructor(){super(...arguments),this.completions=new sf(this._client)}}sg.Completions=sf;let sy=Symbol("brand.privateNullableHeaders"),s_=e=>{let t=new Headers,s=new Set;for(let n of e){let e=new Set;for(let[r,i]of function*(e){let t;if(!e)return;if(sy in e){let{values:t,nulls:s}=e;for(let e of(yield*t.entries(),s))yield[e,null];return}let s=!1;for(let n of(e instanceof Headers?t=e.entries():eQ(e)?t=e:(s=!0,t=Object.entries(e??{})),t)){let e=n[0];if("string"!=typeof e)throw TypeError("expected header name to be a string");let t=eQ(n[1])?n[1]:[n[1]],r=!1;for(let n of t)void 0!==n&&(s&&!r&&(r=!0,yield[e,null]),yield[e,n])}}(n)){let n=r.toLowerCase();e.has(n)||(t.delete(r),e.add(n)),null===i?(t.delete(r),s.add(n)):(t.append(r,i),s.delete(n))}}return{[sy]:!0,values:t,nulls:s}};class sb extends t1{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:s_([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class sw extends t1{create(e,t){return this._client.post("/audio/transcriptions",tF({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class sv extends t1{create(e,t){return this._client.post("/audio/translations",tF({body:e,...t,__metadata:{model:e.model}},this._client))}}class sx extends t1{constructor(){super(...arguments),this.transcriptions=new sw(this._client),this.translations=new sv(this._client),this.speech=new sb(this._client)}}sx.Transcriptions=sw,sx.Translations=sv,sx.Speech=sb;class sS extends t1{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(t4`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",tL,{query:e,...t})}cancel(e,t){return this._client.post(t4`/batches/${e}/cancel`,t)}}class sA extends t1{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(t4`/assistants/${e}`,{...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(t4`/assistants/${e}`,{body:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",tL,{query:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(t4`/assistants/${e}`,{...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class sI extends t1{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class sR extends t1{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class s$ extends t1{constructor(){super(...arguments),this.sessions=new sI(this._client),this.transcriptionSessions=new sR(this._client)}}s$.Sessions=sI,s$.TranscriptionSessions=sR;class sP extends t1{create(e,t,s){return this._client.post(t4`/threads/${e}/messages`,{body:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){let{thread_id:n}=t;return this._client.get(t4`/threads/${n}/messages/${e}`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){let{thread_id:n,...r}=t;return this._client.post(t4`/threads/${n}/messages/${e}`,{body:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(t4`/threads/${e}/messages`,tL,{query:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){let{thread_id:n}=t;return this._client.delete(t4`/threads/${n}/messages/${e}`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class sE extends t1{retrieve(e,t,s){let{thread_id:n,run_id:r,...i}=t;return this._client.get(t4`/threads/${n}/runs/${r}/steps/${e}`,{query:i,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t,s){let{thread_id:n,...r}=t;return this._client.getAPIList(t4`/threads/${n}/runs/${e}/steps`,tL,{query:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}let sO=e=>{if("undefined"!=typeof Buffer){let t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{let t=atob(e),s=t.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}},sk=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;class sC extends sr{constructor(){super(...arguments),B.add(this),F.set(this,[]),W.set(this,{}),H.set(this,{}),X.set(this,void 0),J.set(this,void 0),V.set(this,void 0),z.set(this,void 0),K.set(this,void 0),G.set(this,void 0),Y.set(this,void 0),Q.set(this,void 0),ee.set(this,void 0)}[(F=new WeakMap,W=new WeakMap,H=new WeakMap,X=new WeakMap,J=new WeakMap,V=new WeakMap,z=new WeakMap,K=new WeakMap,G=new WeakMap,Y=new WeakMap,Q=new WeakMap,ee=new WeakMap,B=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("event",s=>{let n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{for(let e of(s=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new D;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();let n=t$.fromReadableStream(e,this.controller);for await(let e of n)eO(this,B,"m",et).call(this,e);if(n.controller.signal?.aborted)throw new ej;return this._addRun(eO(this,B,"m",es).call(this))}toReadableStream(){return new t$(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,n){let r=new D;return r._run(()=>r._runToolAssistantStream(e,t,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createToolAssistantStream(e,t,s,n){let r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));let i={...s,stream:!0},a=await e.submitToolOutputs(t,i,{...n,signal:this.controller.signal});for await(let e of(this._connected(),a))eO(this,B,"m",et).call(this,e);if(a.controller.signal?.aborted)throw new ej;return this._addRun(eO(this,B,"m",es).call(this))}static createThreadAssistantStream(e,t,s){let n=new D;return n._run(()=>n._threadAssistantStream(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,s,n){let r=new D;return r._run(()=>r._runAssistantStream(e,t,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return eO(this,Y,"f")}currentRun(){return eO(this,Q,"f")}currentMessageSnapshot(){return eO(this,X,"f")}currentRunStepSnapshot(){return eO(this,ee,"f")}async finalRunSteps(){return await this.done(),Object.values(eO(this,W,"f"))}async finalMessages(){return await this.done(),Object.values(eO(this,H,"f"))}async finalRun(){if(await this.done(),!eO(this,J,"f"))throw Error("Final run was not received.");return eO(this,J,"f")}async _createThreadAssistantStream(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));let r={...t,stream:!0},i=await e.createAndRun(r,{...s,signal:this.controller.signal});for await(let e of(this._connected(),i))eO(this,B,"m",et).call(this,e);if(i.controller.signal?.aborted)throw new ej;return this._addRun(eO(this,B,"m",es).call(this))}async _createAssistantStream(e,t,s,n){let r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));let i={...s,stream:!0},a=await e.create(t,i,{...n,signal:this.controller.signal});for await(let e of(this._connected(),a))eO(this,B,"m",et).call(this,e);if(a.controller.signal?.aborted)throw new ej;return this._addRun(eO(this,B,"m",es).call(this))}static accumulateDelta(e,t){for(let[s,n]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=n;continue}let t=e[s];if(null==t||"index"===s||"type"===s){e[s]=n;continue}if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else if(e1(t)&&e1(n))t=this.accumulateDelta(t,n);else if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(let e of n){if(!e1(e))throw Error(`Expected array delta entry to be an object but got: ${e}`);let s=e.index;if(null==s)throw console.error(e),Error("Expected array delta entry to have an `index` property");if("number"!=typeof s)throw Error(`Expected array delta entry \`index\` property to be a number but got ${s}`);let n=t[s];null==n?t.push(e):t[s]=this.accumulateDelta(n,e)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${n}, accValue: ${t}`);e[s]=t}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,n){return await this._createAssistantStream(t,e,s,n)}async _runToolAssistantStream(e,t,s,n){return await this._createToolAssistantStream(t,e,s,n)}}D=sC,et=function(e){if(!this.ended)switch(eE(this,Y,e,"f"),eO(this,B,"m",ei).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":eO(this,B,"m",ec).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":eO(this,B,"m",er).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":eO(this,B,"m",en).call(this,e);break;case"error":throw Error("Encountered an error event in event processing - errors should be processed earlier")}},es=function(){if(this.ended)throw new eT("stream has ended, this shouldn't happen");if(!eO(this,J,"f"))throw Error("Final run has not been received");return eO(this,J,"f")},en=function(e){let[t,s]=eO(this,B,"m",eo).call(this,e,eO(this,X,"f"));for(let e of(eE(this,X,t,"f"),eO(this,H,"f")[t.id]=t,s)){let s=t.content[e.index];s?.type=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let s of e.data.delta.content){if("text"==s.type&&s.text){let e=s.text,n=t.content[s.index];if(n&&"text"==n.type)this._emit("textDelta",e,n.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=eO(this,V,"f")){if(eO(this,z,"f"))switch(eO(this,z,"f").type){case"text":this._emit("textDone",eO(this,z,"f").text,eO(this,X,"f"));break;case"image_file":this._emit("imageFileDone",eO(this,z,"f").image_file,eO(this,X,"f"))}eE(this,V,s.index,"f")}eE(this,z,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==eO(this,V,"f")){let t=e.data.content[eO(this,V,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,eO(this,X,"f"));break;case"text":this._emit("textDone",t.text,eO(this,X,"f"))}}eO(this,X,"f")&&this._emit("messageDone",e.data),eE(this,X,void 0,"f")}},er=function(e){let t=eO(this,B,"m",ea).call(this,e);switch(eE(this,ee,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let s=e.data.delta;if(s.step_details&&"tool_calls"==s.step_details.type&&s.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(let e of s.step_details.tool_calls)e.index==eO(this,K,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(eO(this,G,"f")&&this._emit("toolCallDone",eO(this,G,"f")),eE(this,K,e.index,"f"),eE(this,G,t.step_details.tool_calls[e.index],"f"),eO(this,G,"f")&&this._emit("toolCallCreated",eO(this,G,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":eE(this,ee,void 0,"f"),"tool_calls"==e.data.step_details.type&&eO(this,G,"f")&&(this._emit("toolCallDone",eO(this,G,"f")),eE(this,G,void 0,"f")),this._emit("runStepDone",e.data,t)}},ei=function(e){eO(this,F,"f").push(e),this._emit("event",e)},ea=function(e){switch(e.event){case"thread.run.step.created":return eO(this,W,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=eO(this,W,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){let n=D.accumulateDelta(t,s.delta);eO(this,W,"f")[e.data.id]=n}return eO(this,W,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":eO(this,W,"f")[e.data.id]=e.data}if(eO(this,W,"f")[e.data.id])return eO(this,W,"f")[e.data.id];throw Error("No snapshot available")},eo=function(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(let e of n.delta.content)if(e.index in t.content){let s=t.content[e.index];t.content[e.index]=eO(this,B,"m",el).call(this,e,s)}else t.content[e.index]=e,s.push(e);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},el=function(e,t){return D.accumulateDelta(t,e)},ec=function(e){switch(eE(this,Q,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":eE(this,J,e.data,"f"),eO(this,G,"f")&&(this._emit("toolCallDone",eO(this,G,"f")),eE(this,G,void 0,"f"))}};class sN extends t1{constructor(){super(...arguments),this.steps=new sE(this._client)}create(e,t,s){let{include:n,...r}=t;return this._client.post(t4`/threads/${e}/runs`,{query:{include:n},body:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}retrieve(e,t,s){let{thread_id:n}=t;return this._client.get(t4`/threads/${n}/runs/${e}`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){let{thread_id:n,...r}=t;return this._client.post(t4`/threads/${n}/runs/${e}`,{body:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(t4`/threads/${e}/runs`,tL,{query:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){let{thread_id:n}=t;return this._client.post(t4`/threads/${n}/runs/${e}/cancel`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){let n=await this.create(e,t,s);return await this.poll(n.id,{thread_id:e},s)}createAndStream(e,t,s){return sC.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){let n=s_([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:r,response:i}=await this.retrieve(e,t,{...s,headers:{...s?.headers,...n}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let a=5e3;if(s?.pollIntervalMs)a=s.pollIntervalMs;else{let e=i.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(a=t)}}await e4(a);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,s){return sC.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s){let{thread_id:n,...r}=t;return this._client.post(t4`/threads/${n}/runs/${e}/submit_tool_outputs`,{body:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,s){let n=await this.submitToolOutputs(e,t,s);return await this.poll(n.id,t,s)}submitToolOutputsStream(e,t,s){return sC.createToolAssistantStream(e,this._client.beta.threads.runs,t,s)}}sN.Steps=sE;class sT extends t1{constructor(){super(...arguments),this.runs=new sN(this._client),this.messages=new sP(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(t4`/threads/${e}`,{...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(t4`/threads/${e}`,{body:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t){return this._client.delete(t4`/threads/${e}`,{...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){let s=await this.createAndRun(e,t);return await this.runs.poll(s.id,{thread_id:s.thread_id},t)}createAndRunStream(e,t){return sC.createThreadAssistantStream(e,this._client.beta.threads,t)}}sT.Runs=sN,sT.Messages=sP;class sM extends t1{constructor(){super(...arguments),this.realtime=new s$(this._client),this.assistants=new sA(this._client),this.threads=new sT(this._client)}}sM.Realtime=s$,sM.Assistants=sA,sM.Threads=sT;class sj extends t1{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class sL extends t1{retrieve(e,t,s){let{container_id:n}=t;return this._client.get(t4`/containers/${n}/files/${e}/content`,{...s,headers:s_([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}}class sZ extends t1{constructor(){super(...arguments),this.content=new sL(this._client)}create(e,t,s){return this._client.post(t4`/containers/${e}/files`,tF({body:t,...s},this._client))}retrieve(e,t,s){let{container_id:n}=t;return this._client.get(t4`/containers/${n}/files/${e}`,s)}list(e,t={},s){return this._client.getAPIList(t4`/containers/${e}/files`,tL,{query:t,...s})}delete(e,t,s){let{container_id:n}=t;return this._client.delete(t4`/containers/${n}/files/${e}`,{...s,headers:s_([{Accept:"*/*"},s?.headers])})}}sZ.Content=sL;class sU extends t1{constructor(){super(...arguments),this.files=new sZ(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(t4`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",tL,{query:e,...t})}delete(e,t){return this._client.delete(t4`/containers/${e}`,{...t,headers:s_([{Accept:"*/*"},t?.headers])})}}sU.Files=sZ;class sq extends t1{create(e,t,s){let{include:n,...r}=t;return this._client.post(t4`/conversations/${e}/items`,{query:{include:n},body:r,...s})}retrieve(e,t,s){let{conversation_id:n,...r}=t;return this._client.get(t4`/conversations/${n}/items/${e}`,{query:r,...s})}list(e,t={},s){return this._client.getAPIList(t4`/conversations/${e}/items`,tZ,{query:t,...s})}delete(e,t,s){let{conversation_id:n}=t;return this._client.delete(t4`/conversations/${n}/items/${e}`,s)}}class sB extends t1{constructor(){super(...arguments),this.items=new sq(this._client)}create(e,t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(t4`/conversations/${e}`,t)}update(e,t,s){return this._client.post(t4`/conversations/${e}`,{body:t,...s})}delete(e,t){return this._client.delete(t4`/conversations/${e}`,t)}}sB.Items=sq;class sD extends t1{create(e,t){let s=!!e.encoding_format,n=s?e.encoding_format:"base64";s&&tI(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);let r=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return s?r:(tI(this._client).debug("embeddings/decoding base64 embeddings from base64"),r._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{let t=e.embedding;e.embedding=sO(t)}),e)))}}class sF extends t1{retrieve(e,t,s){let{eval_id:n,run_id:r}=t;return this._client.get(t4`/evals/${n}/runs/${r}/output_items/${e}`,s)}list(e,t,s){let{eval_id:n,...r}=t;return this._client.getAPIList(t4`/evals/${n}/runs/${e}/output_items`,tL,{query:r,...s})}}class sW extends t1{constructor(){super(...arguments),this.outputItems=new sF(this._client)}create(e,t,s){return this._client.post(t4`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){let{eval_id:n}=t;return this._client.get(t4`/evals/${n}/runs/${e}`,s)}list(e,t={},s){return this._client.getAPIList(t4`/evals/${e}/runs`,tL,{query:t,...s})}delete(e,t,s){let{eval_id:n}=t;return this._client.delete(t4`/evals/${n}/runs/${e}`,s)}cancel(e,t,s){let{eval_id:n}=t;return this._client.post(t4`/evals/${n}/runs/${e}`,s)}}sW.OutputItems=sF;class sH extends t1{constructor(){super(...arguments),this.runs=new sW(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(t4`/evals/${e}`,t)}update(e,t,s){return this._client.post(t4`/evals/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/evals",tL,{query:e,...t})}delete(e,t){return this._client.delete(t4`/evals/${e}`,t)}}sH.Runs=sW;class sX extends t1{create(e,t){return this._client.post("/files",tF({body:e,...t},this._client))}retrieve(e,t){return this._client.get(t4`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",tL,{query:e,...t})}delete(e,t){return this._client.delete(t4`/files/${e}`,t)}content(e,t){return this._client.get(t4`/files/${e}/content`,{...t,headers:s_([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=18e5}={}){let n=new Set(["processed","error","deleted"]),r=Date.now(),i=await this.retrieve(e);for(;!i.status||!n.has(i.status);)if(await e4(t),i=await this.retrieve(e),Date.now()-r>s)throw new eZ({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return i}}class sJ extends t1{}class sV extends t1{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class sz extends t1{constructor(){super(...arguments),this.graders=new sV(this._client)}}sz.Graders=sV;class sK extends t1{create(e,t,s){return this._client.getAPIList(t4`/fine_tuning/checkpoints/${e}/permissions`,tj,{body:t,method:"post",...s})}retrieve(e,t={},s){return this._client.get(t4`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...s})}delete(e,t,s){let{fine_tuned_model_checkpoint:n}=t;return this._client.delete(t4`/fine_tuning/checkpoints/${n}/permissions/${e}`,s)}}class sG extends t1{constructor(){super(...arguments),this.permissions=new sK(this._client)}}sG.Permissions=sK;class sY extends t1{list(e,t={},s){return this._client.getAPIList(t4`/fine_tuning/jobs/${e}/checkpoints`,tL,{query:t,...s})}}class sQ extends t1{constructor(){super(...arguments),this.checkpoints=new sY(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(t4`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",tL,{query:e,...t})}cancel(e,t){return this._client.post(t4`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return this._client.getAPIList(t4`/fine_tuning/jobs/${e}/events`,tL,{query:t,...s})}pause(e,t){return this._client.post(t4`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(t4`/fine_tuning/jobs/${e}/resume`,t)}}sQ.Checkpoints=sY;class s0 extends t1{constructor(){super(...arguments),this.methods=new sJ(this._client),this.jobs=new sQ(this._client),this.checkpoints=new sG(this._client),this.alpha=new sz(this._client)}}s0.Methods=sJ,s0.Jobs=sQ,s0.Checkpoints=sG,s0.Alpha=sz;class s1 extends t1{}class s2 extends t1{constructor(){super(...arguments),this.graderModels=new s1(this._client)}}s2.GraderModels=s1;class s5 extends t1{createVariation(e,t){return this._client.post("/images/variations",tF({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",tF({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class s4 extends t1{retrieve(e,t){return this._client.get(t4`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",tj,e)}delete(e,t){return this._client.delete(t4`/models/${e}`,t)}}class s3 extends t1{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function s6(e,t){let s=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:function(e,t){var s,n,r;let i=(s=e.tools??[],n=t.name,s.find(e=>"function"===e.type&&e.name===n));return{...t,...t,parsed_arguments:(r=i,r?.$brand==="auto-parseable-tool")?i.$parseRaw(t.arguments):i?.strict?JSON.parse(t.arguments):null}}(t,e)};if("message"===e.type){let s=e.content.map(e=>{var s;return"output_text"===e.type?{...e,parsed:(s=e.text,t.text?.format?.type!=="json_schema"?null:"$parseRaw"in t.text?.format?(t.text?.format).$parseRaw(s):JSON.parse(s))}:e});return{...e,content:s}}return e}),n=Object.assign({},e,{output:s});return Object.getOwnPropertyDescriptor(e,"output_text")||s8(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(let e of n.output)if("message"===e.type){for(let t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed}return null}}),n}function s8(e){let t=[];for(let s of e.output)if("message"===s.type)for(let e of s.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}class s9 extends sr{constructor(e){super(),eu.add(this),eh.set(this,void 0),ed.set(this,void 0),ep.set(this,void 0),eE(this,eh,e,"f")}static createResponse(e,t,s){let n=new s9(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,s){let n;let r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),eO(this,eu,"m",em).call(this);let i=null;for await(let r of("response_id"in t?(n=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):n=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected(),n))eO(this,eu,"m",ef).call(this,r,i);if(n.controller.signal?.aborted)throw new ej;return eO(this,eu,"m",eg).call(this)}[(eh=new WeakMap,ed=new WeakMap,ep=new WeakMap,eu=new WeakSet,em=function(){this.ended||eE(this,ed,void 0,"f")},ef=function(e,t){if(this.ended)return;let s=(e,s)=>{(null==t||s.sequence_number>t)&&this._emit(e,s)},n=eO(this,eu,"m",ey).call(this,e);switch(s("event",e),e.type){case"response.output_text.delta":{let t=n.output[e.output_index];if(!t)throw new eT(`missing output at index ${e.output_index}`);if("message"===t.type){let n=t.content[e.content_index];if(!n)throw new eT(`missing content at index ${e.content_index}`);if("output_text"!==n.type)throw new eT(`expected content to be 'output_text', got ${n.type}`);s("response.output_text.delta",{...e,snapshot:n.text})}break}case"response.function_call_arguments.delta":{let t=n.output[e.output_index];if(!t)throw new eT(`missing output at index ${e.output_index}`);"function_call"===t.type&&s("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:s(e.type,e)}},eg=function(){if(this.ended)throw new eT("stream has ended, this shouldn't happen");let e=eO(this,ed,"f");if(!e)throw new eT("request ended without sending any events");eE(this,ed,void 0,"f");let t=function(e,t){return t&&t8(t.text?.format)?s6(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,eO(this,eh,"f"));return eE(this,ep,t,"f"),t},ey=function(e){let t=eO(this,ed,"f");if(!t){if("response.created"!==e.type)throw new eT(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return eE(this,ed,e.response,"f")}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{let s=t.output[e.output_index];if(!s)throw new eT(`missing output at index ${e.output_index}`);"message"===s.type&&s.content.push(e.part);break}case"response.output_text.delta":{let s=t.output[e.output_index];if(!s)throw new eT(`missing output at index ${e.output_index}`);if("message"===s.type){let t=s.content[e.content_index];if(!t)throw new eT(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new eT(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{let s=t.output[e.output_index];if(!s)throw new eT(`missing output at index ${e.output_index}`);"function_call"===s.type&&(s.arguments+=e.delta);break}case"response.completed":eE(this,ed,e.response,"f")}return t},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("event",s=>{let n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{for(let e of(s=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=eO(this,ep,"f");if(!e)throw new eT("stream ended without producing a ChatCompletion");return e}}class s7 extends t1{list(e,t={},s){return this._client.getAPIList(t4`/responses/${e}/input_items`,tL,{query:t,...s})}}class ne extends t1{constructor(){super(...arguments),this.inputItems=new s7(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&s8(e),e))}retrieve(e,t={},s){return this._client.get(t4`/responses/${e}`,{query:t,...s,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&s8(e),e))}delete(e,t){return this._client.delete(t4`/responses/${e}`,{...t,headers:s_([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>s6(t,e))}stream(e,t){return s9.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(t4`/responses/${e}/cancel`,t)}}ne.InputItems=s7;class nt extends t1{create(e,t,s){return this._client.post(t4`/uploads/${e}/parts`,tF({body:t,...s},this._client))}}class ns extends t1{constructor(){super(...arguments),this.parts=new nt(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(t4`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(t4`/uploads/${e}/complete`,{body:t,...s})}}ns.Parts=nt;let nn=async e=>{let t=await Promise.allSettled(e),s=t.filter(e=>"rejected"===e.status);if(s.length){for(let e of s)console.error(e.reason);throw Error(`${s.length} promise(s) failed - see the above errors`)}let n=[];for(let e of t)"fulfilled"===e.status&&n.push(e.value);return n};class nr extends t1{create(e,t,s){return this._client.post(t4`/vector_stores/${e}/file_batches`,{body:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){let{vector_store_id:n}=t;return this._client.get(t4`/vector_stores/${n}/file_batches/${e}`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){let{vector_store_id:n}=t;return this._client.post(t4`/vector_stores/${n}/file_batches/${e}/cancel`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){let n=await this.create(e,t);return await this.poll(e,n.id,s)}listFiles(e,t,s){let{vector_store_id:n,...r}=t;return this._client.getAPIList(t4`/vector_stores/${n}/file_batches/${e}/files`,tL,{query:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async poll(e,t,s){let n=s_([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:r,response:i}=await this.retrieve(t,{vector_store_id:e},{...s,headers:n}).withResponse();switch(r.status){case"in_progress":let a=5e3;if(s?.pollIntervalMs)a=s.pollIntervalMs;else{let e=i.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(a=t)}}await e4(a);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},n){if(null==t||0==t.length)throw Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let r=Math.min(n?.maxConcurrency??5,t.length),i=this._client,a=t.values(),o=[...s];async function l(e){for(let t of e){let e=await i.files.create({file:t,purpose:"assistants"},n);o.push(e.id)}}let c=Array(r).fill(a).map(l);return await nn(c),await this.createAndPoll(e,{file_ids:o})}}class ni extends t1{create(e,t,s){return this._client.post(t4`/vector_stores/${e}/files`,{body:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){let{vector_store_id:n}=t;return this._client.get(t4`/vector_stores/${n}/files/${e}`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){let{vector_store_id:n,...r}=t;return this._client.post(t4`/vector_stores/${n}/files/${e}`,{body:r,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(t4`/vector_stores/${e}/files`,tL,{query:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){let{vector_store_id:n}=t;return this._client.delete(t4`/vector_stores/${n}/files/${e}`,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){let n=await this.create(e,t,s);return await this.poll(e,n.id,s)}async poll(e,t,s){let n=s_([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){let r=await this.retrieve(t,{vector_store_id:e},{...s,headers:n}).withResponse(),i=r.data;switch(i.status){case"in_progress":let a=5e3;if(s?.pollIntervalMs)a=s.pollIntervalMs;else{let e=r.response.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(a=t)}}await e4(a);break;case"failed":case"completed":return i}}}async upload(e,t,s){let n=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:n.id},s)}async uploadAndPoll(e,t,s){let n=await this.upload(e,t,s);return await this.poll(e,n.id,s)}content(e,t,s){let{vector_store_id:n}=t;return this._client.getAPIList(t4`/vector_stores/${n}/files/${e}/content`,tj,{...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class na extends t1{constructor(){super(...arguments),this.files=new ni(this._client),this.fileBatches=new nr(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(t4`/vector_stores/${e}`,{...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(t4`/vector_stores/${e}`,{body:t,...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",tL,{query:e,...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(t4`/vector_stores/${e}`,{...t,headers:s_([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,s){return this._client.getAPIList(t4`/vector_stores/${e}/search`,tj,{body:t,method:"post",...s,headers:s_([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}na.Files=ni,na.FileBatches=nr;class no extends t1{constructor(){super(...arguments),e_.add(this)}async unwrap(e,t,s=this._client.webhookSecret,n=300){return await this.verifySignature(e,t,s,n),JSON.parse(e)}async verifySignature(e,t,s=this._client.webhookSecret,n=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw Error("Webhook signature verification is only supported when the `crypto` global is defined");eO(this,e_,"m",eb).call(this,s);let r=s_([t]).values,i=eO(this,e_,"m",ew).call(this,r,"webhook-signature"),a=eO(this,e_,"m",ew).call(this,r,"webhook-timestamp"),o=eO(this,e_,"m",ew).call(this,r,"webhook-id"),l=parseInt(a,10);if(isNaN(l))throw new ez("Invalid webhook timestamp format");let c=Math.floor(Date.now()/1e3);if(c-l>n)throw new ez("Webhook timestamp is too old");if(l>c+n)throw new ez("Webhook timestamp is too new");let u=i.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),h=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),d=o?`${o}.${a}.${e}`:`${a}.${e}`,p=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(let e of u)try{let t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",p,t,new TextEncoder().encode(d)))return}catch{continue}throw new ez("The given webhook signature does not match the expected signature")}}e_=new WeakSet,eb=function(e){if("string"!=typeof e||0===e.length)throw Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},ew=function(e,t){if(!e)throw Error("Headers are required");let s=e.get(t);if(null==s)throw Error(`Missing required header: ${t}`);return s};class nl{constructor({baseURL:e=sk("OPENAI_BASE_URL"),apiKey:t=sk("OPENAI_API_KEY"),organization:s=sk("OPENAI_ORG_ID")??null,project:n=sk("OPENAI_PROJECT_ID")??null,webhookSecret:r=sk("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(ev.add(this),eS.set(this,void 0),this.completions=new sj(this),this.chat=new sg(this),this.embeddings=new sD(this),this.files=new sX(this),this.images=new s5(this),this.audio=new sx(this),this.moderations=new s3(this),this.models=new s4(this),this.fineTuning=new s0(this),this.graders=new s2(this),this.vectorStores=new na(this),this.webhooks=new no(this),this.beta=new sM(this),this.batches=new sS(this),this.uploads=new ns(this),this.responses=new ne(this),this.conversations=new sB(this),this.evals=new sH(this),this.containers=new sU(this),void 0===t)throw new eT("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let a={apiKey:t,organization:s,project:n,webhookSecret:r,...i,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&e6())throw new eT("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=a.baseURL,this.timeout=a.timeout??ex.DEFAULT_TIMEOUT,this.logger=a.logger??console;let o="warn";this.logLevel=o,this.logLevel=tw(a.logLevel,"ClientOptions.logLevel",this)??tw(sk("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=a.fetchOptions,this.maxRetries=a.maxRetries??2,this.fetch=a.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),eE(this,eS,ti,"f"),this._options=a,this.apiKey=t,this.organization=s,this.project=n,this.webhookSecret=r}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return s_([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return function(e,t={}){let s,n=e,r=function(e=tm){let t;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw TypeError("Encoder has to be a function.");let s=e.charset||tm.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=ta;if(void 0!==e.format){if(!tc(tl,e.format))throw TypeError("Unknown format option provided.");n=e.format}let r=tl[n],i=tm.filter;if(("function"==typeof e.filter||eY(e.filter))&&(i=e.filter),t=e.arrayFormat&&e.arrayFormat in td?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":tm.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw TypeError("`commaRoundTrip` must be a boolean, or absent");let a=void 0===e.allowDots?!0==!!e.encodeDotInKeys||tm.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:tm.addQueryPrefix,allowDots:a,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:tm.allowEmptyArrays,arrayFormat:t,charset:s,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:tm.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?tm.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:tm.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:tm.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:tm.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:tm.encodeValuesOnly,filter:i,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:tm.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:tm.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:tm.strictNullHandling}}(t);"function"==typeof r.filter?n=(0,r.filter)("",n):eY(r.filter)&&(s=r.filter);let i=[];if("object"!=typeof n||null===n)return"";let a=td[r.arrayFormat],o="comma"===a&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);let l=new WeakMap;for(let e=0;e<s.length;++e){let t=s[e];r.skipNulls&&null===n[t]||tp(i,function e(t,s,n,r,i,a,o,l,c,u,h,d,p,m,f,g,y,_){var b,w;let v,x=t,S=_,A=0,I=!1;for(;void 0!==(S=S.get(tf))&&!I;){let e=S.get(t);if(A+=1,void 0!==e){if(e===A)throw RangeError("Cyclic object value");I=!0}void 0===S.get(tf)&&(A=0)}if("function"==typeof u?x=u(s,x):x instanceof Date?x=p?.(x):"comma"===n&&eY(x)&&(x=th(x,function(e){return e instanceof Date?p?.(e):e})),null===x){if(a)return c&&!g?c(s,tm.encoder,y,"key",m):s;x=""}if("string"==typeof(b=x)||"number"==typeof b||"boolean"==typeof b||"symbol"==typeof b||"bigint"==typeof b||(w=x)&&"object"==typeof w&&w.constructor&&w.constructor.isBuffer&&w.constructor.isBuffer(w)){if(c){let e=g?s:c(s,tm.encoder,y,"key",m);return[f?.(e)+"="+f?.(c(x,tm.encoder,y,"value",m))]}return[f?.(s)+"="+f?.(String(x))]}let R=[];if(void 0===x)return R;if("comma"===n&&eY(x))g&&c&&(x=th(x,c)),v=[{value:x.length>0?x.join(",")||null:void 0}];else if(eY(u))v=u;else{let e=Object.keys(x);v=h?e.sort(h):e}let $=l?String(s).replace(/\./g,"%2E"):String(s),P=r&&eY(x)&&1===x.length?$+"[]":$;if(i&&eY(x)&&0===x.length)return P+"[]";for(let s=0;s<v.length;++s){let b=v[s],w="object"==typeof b&&void 0!==b.value?b.value:x[b];if(o&&null===w)continue;let S=d&&l?b.replace(/\./g,"%2E"):b,I=eY(x)?"function"==typeof n?n(P,S):P:P+(d?"."+S:"["+S+"]");_.set(t,A);let $=new WeakMap;$.set(tf,_),tp(R,e(w,I,n,r,i,a,o,l,"comma"===n&&g&&eY(x)?null:c,u,h,d,p,m,f,g,y,$))}return R}(n[t],t,a,o,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,l))}let c=i.join(r.delimiter),u=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?u+="utf8=%26%2310003%3B&":u+="utf8=%E2%9C%93&"),c.length>0?u+c:""}(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${e3}`}defaultIdempotencyKey(){return`stainless-node-retry-${ek()}`}makeStatusError(e,t,s,n){return eM.generate(e,t,s,n)}buildURL(e,t,s){let n=!eO(this,ev,"m",eA).call(this)&&s||this.baseURL,r=new URL(eG(e)?e:n+(n.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return!function(e){if(!e)return!0;for(let t in e)return!1;return!0}(i)&&(t={...i,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new tN(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){let n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);let{req:i,url:a,timeout:o}=await this.buildRequest(n,{retryCount:r-t});await this.prepareRequest(i,{url:a,options:n});let l="log_"+(16777216*Math.random()|0).toString(16).padStart(6,"0"),c=void 0===s?"":`, retryOf: ${s}`,u=Date.now();if(tI(this).debug(`[${l}] sending request`,tR({retryOfRequestLogID:s,method:n.method,url:a,options:n,headers:i.headers})),n.signal?.aborted)throw new ej;let h=new AbortController,d=await this.fetchWithTimeout(a,i,o,h).catch(eN),p=Date.now();if(d instanceof Error){let e=`retrying, ${t} attempts remaining`;if(n.signal?.aborted)throw new ej;let r=eC(d)||/timed? ?out/i.test(String(d)+("cause"in d?String(d.cause):""));if(t)return tI(this).info(`[${l}] connection ${r?"timed out":"failed"} - ${e}`),tI(this).debug(`[${l}] connection ${r?"timed out":"failed"} (${e})`,tR({retryOfRequestLogID:s,url:a,durationMs:p-u,message:d.message})),this.retryRequest(n,t,s??l);if(tI(this).info(`[${l}] connection ${r?"timed out":"failed"} - error; no more retries left`),tI(this).debug(`[${l}] connection ${r?"timed out":"failed"} (error; no more retries left)`,tR({retryOfRequestLogID:s,url:a,durationMs:p-u,message:d.message})),r)throw new eZ;throw new eL({cause:d})}let m=[...d.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join(""),f=`[${l}${c}${m}] ${i.method} ${a} ${d.ok?"succeeded":"failed"} with status ${d.status} in ${p-u}ms`;if(!d.ok){let e=await this.shouldRetry(d);if(t&&e){let e=`retrying, ${t} attempts remaining`;return await tr(d.body),tI(this).info(`${f} - ${e}`),tI(this).debug(`[${l}] response error (${e})`,tR({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:p-u})),this.retryRequest(n,t,s??l,d.headers)}let r=e?"error; no more retries left":"error; not retryable";tI(this).info(`${f} - ${r}`);let i=await d.text().catch(e=>eN(e).message),a=e5(i),o=a?void 0:i;throw tI(this).debug(`[${l}] response error (${r})`,tR({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,message:o,durationMs:Date.now()-u})),this.makeStatusError(d.status,a,o,d.headers)}return tI(this).info(f),tI(this).debug(`[${l}] response start`,tR({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:p-u})),{response:d,options:n,controller:h,requestLogID:l,retryOfRequestLogID:s,startTime:u}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){return new tM(this,this.makeRequest(t,null,void 0),e)}async fetchWithTimeout(e,t,s,n){let{signal:r,method:i,...a}=t||{};r&&r.addEventListener("abort",()=>n.abort());let o=setTimeout(()=>n.abort(),s),l=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||"object"==typeof a.body&&null!==a.body&&Symbol.asyncIterator in a.body,c={signal:n.signal,...l?{duplex:"half"}:{},method:"GET",...a};i&&(c.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,c)}finally{clearTimeout(o)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,s,n){let r;let i=n?.get("retry-after-ms");if(i){let e=parseFloat(i);Number.isNaN(e)||(r=e)}let a=n?.get("retry-after");if(a&&!r){let e=parseFloat(a);r=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){let s=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,s)}return await e4(r),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){return Math.min(.5*Math.pow(2,t-e),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){let s={...e},{method:n,path:r,query:i,defaultBaseURL:a}=s,o=this.buildURL(r,i,a);"timeout"in s&&e2("timeout",s.timeout),s.timeout=s.timeout??this.timeout;let{bodyHeaders:l,body:c}=this.buildBody({options:s}),u=await this.buildHeaders({options:e,method:n,bodyHeaders:l,retryCount:t});return{req:{method:n,headers:u,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&c instanceof globalThis.ReadableStream&&{duplex:"half"},...c&&{body:c},...this.fetchOptions??{},...s.fetchOptions??{}},url:o,timeout:s.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:n}){let r={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);let i=s_([r,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...te(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let s=s_([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:ts(e)}:eO(this,eS,"f").call(this,{body:e,headers:s})}}ex=nl,eS=new WeakMap,ev=new WeakSet,eA=function(){return"https://api.openai.com/v1"!==this.baseURL},nl.OpenAI=ex,nl.DEFAULT_TIMEOUT=6e5,nl.OpenAIError=eT,nl.APIError=eM,nl.APIConnectionError=eL,nl.APIConnectionTimeoutError=eZ,nl.APIUserAbortError=ej,nl.NotFoundError=eD,nl.ConflictError=eF,nl.RateLimitError=eH,nl.BadRequestError=eU,nl.AuthenticationError=eq,nl.InternalServerError=eX,nl.PermissionDeniedError=eB,nl.UnprocessableEntityError=eW,nl.InvalidWebhookSignatureError=ez,nl.toFile=tQ,nl.Completions=sj,nl.Chat=sg,nl.Embeddings=sD,nl.Files=sX,nl.Images=s5,nl.Audio=sx,nl.Moderations=s3,nl.Models=s4,nl.FineTuning=s0,nl.Graders=s2,nl.VectorStores=na,nl.Webhooks=no,nl.Beta=sM,nl.Batches=sS,nl.Uploads=ns,nl.Responses=ne,nl.Conversations=sB,nl.Evals=sH,nl.Containers=sU}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),n=t.X(0,[379,823,937],()=>s(7683));module.exports=n})();